#!/bin/php
<?
//
// Mybox Firewall - A Firewall Appliance
// http://www.mybox.net.my/
//
// (C) Copyright 2002,2003,2004 Mohd Nawawi Mohamad Jamili, TraceNetwork Corporation Sdn. Bhd.
//
// This program is not free software; you cannot redistribute it and/or
// modify without permission copyright owner.
//
// This code is protected by copyright law and international treaties. 
// Unauthorized reproduction or distribution of this program, or any portion of it, 
// may result in severe civil and criminal penalties, and will be prosecuted to the 
// maximum extent possible under the law.
//
// $Id: network3.so,v 1.00 2003/07/28 1:07 AM nawawi Exp $
//
	include_once('scripts/functions.inc');
	include_once('scripts/auth.inc');
	$_ACCESS=chk_session();
	if($_ACCESS=='' || is_admin($_ACCESS)) {
		write_userlog('Accessing Network -> ARP Cache page','Access denied');
		go_exit();
	}
	if(is_admin($_ACCESS)) {
		write_userlog('Accessing Network -> ARP Cache page','Access denied -> Not Admin');
		echo "you're on candid camera..";
		exit;
	}
	function arp_clear() {
		$handle=popen('dnet arp show 2>&1','r');
		while($buff=fgets($handle,4096)) {
			$buff=trim($buff);
			list($ip,$rest)=preg_split("/\s+/",$buff);
			if($ip!='') {
				shell_exec("dnet arp delete $ip 2>&1");
			}
		}
		pclose($handle);
		write_userlog('Executing Network -> ARP Cache -> ARP Clear','Action granted');
	}
	if(isset($do)&& $do=='1') { 
		if(file_exists('/hd/configs/arpa.lst')) unlink('/hd/configs/arpa.lst');
		if(file_exists('/tmp/arpa.cache')) unlink('/tmp/arpa.cache');
		arp_clear();
		header("Location: network_msg.so?msg=Please wait.. clearing cache&ref=network3.so");
	}

	// start
	$currentPage = $HTTP_SERVER_VARS["PHP_SELF"];
	$pageNum_Recordset='0';
	$maxRows_Recordset=50;
	if(isset($HTTP_GET_VARS['pageNum_Recordset'])) {
  		$pageNum_Recordset = $HTTP_GET_VARS['pageNum_Recordset'];
	}
	$startRow_Recordset = $pageNum_Recordset * $maxRows_Recordset;

	if(!isset($log)) {
		if(file_exists('/hd/configs/arpa.lst')) {
			copy('/hd/configs/arpa.lst','/tmp/arpa.cache');
		}
		$log='/tmp/arpa.cache';
	}

	$row_Recordset=array();
	if(file_exists("$log")) {
		$line=file("$log");
		$i='1';
		for($x=$startRow_Recordset;$x<count($line);$x++) {
			$buff=$line[$x];
			$buff=trim($buff);
			if($buff!='' && $i!=$maxRows_Recordset) {
				array_push($row_Recordset,$buff);
				$i++;
			}
		}
	}
	if(isset($HTTP_GET_VARS['totalRows_Recordset'])) {
  		$totalRows_Recordset = $HTTP_GET_VARS['totalRows_Recordset'];
	} else {
  		$totalRows_Recordset=count($line);
	}

	$totalPages_Recordset=ceil($totalRows_Recordset/$maxRows_Recordset)-1;
	$queryString_Recordset = "";
	if(!empty($HTTP_SERVER_VARS['QUERY_STRING'])) {
  		$params = explode("&", $HTTP_SERVER_VARS['QUERY_STRING']);
  		$newParams = array();
  		foreach ($params as $param) {
    			if (stristr($param, "pageNum_Recordset") == false && 
        			stristr($param, "totalRows_Recordset") == false) {
      				array_push($newParams, $param);
    			}
  		}
  		if (count($newParams) != 0) {
    			$queryString_Recordset = "&" . implode("&", $newParams);
  		}
	}
	$queryString_Recordset = sprintf("&log=%s&totalRows_Recordset=%d%s", $log, $totalRows_Recordset, $queryString_Recordset);

	write_userlog('Accessing Network -> ARP Cache page','Access granted');
	write_nocache();
?>
<?include_once('scripts/header.inc');?>
<html>
<head>
<title>MyBox Firewall</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<?include_once('scripts/style.css');?>
<?include_once('scripts/network.js');?>
<?include_once('scripts/global.js');?>
<script language="javascript"><!--
	defaultStatus="ARP Cache";
//--></script>
</head>
<body bgcolor="#888888" leftmargin="0" topmargin="0" marginwidth="0" marginheight="0" onload="initjsDOMenu();">
<!-- start console win -->
<center>
<table bgcolor="#eeeeee" height="100%" width="100%" border="0" cellpadding="0" cellspacing="0" class="block0">
<tr valign="top">
<td align="center">	
<table bgcolor="#005a8f" width="100%" border="0" cellpadding="2" cellspacing="0">
<tr valign="center">
<td height="18" align="left" class="td_label" width=10><img src="png.so?path=image&image=online.gif" border=0 alt="<?get_online();?>"></td>
<td height="18" align="left" class="td_label">&nbsp;Network Configuration - ARP Cache</td>
<td height="18" align="right"><a href="blank.so"><img src="png.so?path=image&image=close.png" border="0"></a></td>
</tr>
</table>
<table bgcolor="#d4d0c8" width="100%" height="18" border="0" cellpadding="0" cellspacing="0">
<tr valign="center">
<td>
<form name=e>
<nobr>
<input type=button value="DNS/Gateway" class=input_button onclick="load('network0.so');"><input type=button value="Interfaces Setup" class=input_button onclick="load('network1.so');"><input type=button value="Routing Setup" class=input_button onclick="load('network5.so');"><input type=button value="Host Addresses" class=input_button onclick="load('network2.so');"><input type=button value="ARP Cache" class=input_button onclick="load('network3.so');"><input type=button value="Bandwidth Shaping" class=input_button onclick="load('network4.so');"><input type=button value="Link Failover" class=input_button onclick="load('network6.so');">
</nobr>
</td>
</tr>
<tr><td></form></td></tr>
</table>


<table bgcolor="#eeeeee" width="100%" height="100%" border="0" cellpadding="1" cellspacing="1" class="block">
<tr valign="top">
<td align=center><br><br>

<form name=f action=network3.so?do=1 method=post>
    <table cellpadding="5" border="0" cellspacing="0" align="center">
    <tr>
        <td valign="top" width="700" align=center>
            <fieldset>
                <legend>ARP Cache</legend><br>
                <table border="0" cellspacing="1" cellpadding="0">
                    <tr>
                        <td>
                               <table width="650" border="0" cellpadding="1" cellspacing="1" class=block>
      <tr bgcolor="#6696bc"> 
	<td class=td_pad>IP Address</td>
        <td class=td_pad>Hostname</td>
	<td class=td_pad>Connection</td>
	<td class=td_pad>Name</td>
        <td class=td_pad>User</td>
        <td class=td_pad>HW Address</td>
      </tr>
	<?
		if(count($row_Recordset)>0) {
			foreach($row_Recordset as $buff) {
				$buff=trim($buff);
				if($buff!='') {
					list($hostname,$ip,$nbtname,$cname,$mac)=preg_split("/\|/",$buff);
					if($ip!='') {
						if(check_mynetwork($ip)) {
							$conn="<font color=green>Local IP</font>";
						} else {
							$conn="<font color=red>Public IP</font>";
						}
					}
					echo "
      					<tr bgcolor=#E7E9F2>
					<td class=td_pad>$ip</td>
        				<td class=td_pad>$hostname</td>
					<td class=td_pad>$conn</td>
					<td class=td_pad>$nbtname</td>
        				<td class=td_pad>$cname</td>
        				<td class=td_pad><font color=#CC6600>$mac</font></td>
      					</tr>
					\n";

				}
		
			}
		}
	?>
       <tr> 
    <td  colspan=6 align="center" bgcolor="#c0c0c0" class=block>     
	<? if($pageNum_Recordset > 0) { ?>
      	<a href="<?printf("%s?pageNum_Recordset=%d%s", $currentPage, 0, $queryString_Recordset); ?>"><img src="png.so?path=image&image=first.png" border=0></a>
      <? }  ?>
	<? if ($pageNum_Recordset > 0) {  ?>
      <a href="<? printf("%s?pageNum_Recordset=%d%s", $currentPage, max(0, $pageNum_Recordset - 1), $queryString_Recordset); ?>"><img src="png.so?path=image&image=prev.png" border=0></a>
      <? }  ?>    
	<? if ($pageNum_Recordset < $totalPages_Recordset) {  ?>
      <a href="<? printf("%s?pageNum_Recordset=%d%s", $currentPage, min($totalPages_Recordset, $pageNum_Recordset + 1), $queryString_Recordset); ?>"><img src="png.so?path=image&image=next.png" border=0></a>
      <? }   ?>   
	<? if ($pageNum_Recordset < $totalPages_Recordset) {  ?>
      <a href="<? printf("%s?pageNum_Recordset=%d%s", $currentPage, $totalPages_Recordset, $queryString_Recordset); ?>"><img src="png.so?path=image&image=last.png" border=0></a> 
      <? }   ?>
</td>
	</tr>

</table>
                     </tr>
                        </td>
                    </tr>
                    <tr>
                        <td>
    			<table width="650" border="0" cellpadding="1" cellspacing="1">
        		<tr> 
        		<td width="100%" align=center>
			<input type="button" value="Cancel" class="input_button" onclick="load('network.so');"><input type=submit name="saving" value="  Clear ARP Cache  " class="input_button">
         		</td>
      			</tr>
    			</table>
                        </td>
                   </table>
            </fieldset>
         </td>
    </tr>
    </table>

</form>

</td>
</tr>
</table>

</td>
</tr>
</table>
</center>
<!-- end console win -->
</body>
</html>

<? flush(); ?>
