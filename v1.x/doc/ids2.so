#!/bin/php
<?
//
// Mybox Firewall - A Firewall Appliance
// http://www.mybox.net.my/
//
// (C) Copyright 2002,2003,2004 Mohd Nawawi Mohamad Jamili, TraceNetwork Corporation Sdn. Bhd.
//
// This program is not free software; you cannot redistribute it and/or
// modify without permission copyright owner.
//
// This code is protected by copyright law and international treaties. 
// Unauthorized reproduction or distribution of this program, or any portion of it, 
// may result in severe civil and criminal penalties, and will be prosecuted to the 
// maximum extent possible under the law.
//
// $Id: ids2.so,v 1.00 2003/07/28 1:07 AM nawawi Exp $
//
	include_once('scripts/functions.inc');
	include_once('scripts/auth.inc');
	$_ACCESS=chk_session();
	if($_ACCESS=='' || is_admin($_ACCESS)) {
		write_userlog('Accessing IDS setup','Access denied');
		go_exit();
	}

	function change_rule($file1,$what,$line,$val) {
		if(file_exists("/hd/idsconf/rules/$file1")) {
			$file=file("/hd/idsconf/rules/$file1");
			$pbuf=$file[$line];
			if(preg_match("/msg:(.*);/",$pbuf,$pp)) {
				list($msg,$rest)=preg_split("/;/",$pp[1]);
				$msg=trim($msg,'"');
				$msg3=$msg;
				$msg=str_replace('\\','',$msg);
				if(preg_match("/(\d):(\d)\s+(.*)/",$msg,$rk)) {
					$drop=$rk[1];
					$active=$rk[2];
					$msg0=$rk[3];
					if($what=='drop') $drop=$val;
					if($what=='active') $active=$val;
					$msg0=str_replace(':','\\:',$msg0);
					$msg1="$drop\\:$active $msg0";
					$buff=str_replace($msg3,$msg1,$pbuf);
					$file[$line]="$buff";
					$handle=fopen("/hd/idsconf/rules/$file1",'w');
					foreach($file as $line) {
						if($line!='') {
							$line=trim($line);
							fputs($handle,"$line\n");
						}
					}
					fclose($handle);
				}
			}
			unset($file,$pbuf,$msg,$msg0,$msg1,$active,$drop,$what,$line,$val,$file1);
		}
	}
	function do_delete2($ff,$del) {
		if(file_exists("/hd/idsconf/rules/$ff")&&$del!='') {
			$file=file("/hd/idsconf/rules/$ff");
			foreach($del as $line) {
				$file[$line]='';
			}
			$handle=fopen("/hd/idsconf/rules/$ff",'w');
			foreach($file as $line) {
				$line=trim($line);
				if($line!='') {
					fputs($handle,"$line\n");
				}
			}
			fclose($handle);
		}
	}

	if(isset($ch)&& $ch=='1') {
		$dofile=$fl;
		unset($ch);
	}
	if(isset($ch0)&& $ch0=='1') {
		$dofile=$fl;
		if($drop=='0') {
			$drop='1';
		} else {
			$drop='0';
		}
		change_rule($dofile,'drop',$line,$drop);
		unset($ch0,$line,$drop);
	}
	if(isset($ch0)&& $ch0=='2') {
		$dofile=$fl;
		if($active=='0') {
			$active='1';
		} else {
			$active='0';
		}
		change_rule($dofile,'active',$line,$active);
		unset($ch0,$line,$active);
	}
	if(isset($action)&& $action=='reload') {
		touch('/tmp/ids_reset');
		unset($action);
		header("Location: ids_msg.so?ref=ids2.so&msg=Please wait..reloading IDS signatures..");
	}
	if((isset($action)&& $action=='active') && (isset($ff)&& $ff!='')) {
		if(isset($shf)&& $shf!='') {
			foreach($shf as $line) {
				change_rule($ff,'active',$line,'1');
			}
		}
		$dofile=$ff;
		unset($ff,$line,$shf,$action);
	}
	if((isset($action)&& $action=='noactive') && (isset($ff)&& $ff!='')) {
		if(isset($shf)&& $shf!='') {
			foreach($shf as $line) {
				change_rule($ff,'active',$line,'0');
			}
		}
		$dofile=$ff;
		unset($ff,$line,$shf,$action);
	}
	if((isset($action)&& $action=='drop') && (isset($ff)&& $ff!='')) {
		if(isset($shf)&& $shf!='') {
			foreach($shf as $line) {
				change_rule($ff,'drop',$line,'1');
			}
		}
		$dofile=$ff;
		unset($ff,$line,$shf,$action);
	}
	if((isset($action)&& $action=='nodrop') && (isset($ff)&& $ff!='')) {
		if(isset($shf)&& $shf!='') {
			foreach($shf as $line) {
				change_rule($ff,'drop',$line,'0');
			}
		}
		$dofile=$ff;
		unset($ff,$line,$shf,$action);
	}
	if((isset($action)&& $action=='delete') && (isset($ff)&& $ff!='')) {
		if(isset($shf)&& $shf!='') {
			do_delete2($ff,$shf);
		}
		$dofile=$ff;
		unset($ff,$line,$shf,$action);
	}
	write_nocache();
?>
<?include_once('scripts/header.inc');?>
<html>
<head>
<title>MyBox Firewall</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<?include_once('scripts/style.css');?>
<?include_once('scripts/global.js');?>
<script language="javascript"><!--
	defaultStatus="Manage Signatures";
	function doselect1() {
		var rl=document.f.rl.value;
		self.location.href='ids2.so?ch=1&fl='+rl;
		return;
	}
	function doselect2() {
		var rl=document.f.rl2.value;
		self.location.href='ids2.so?ch=1&fl='+rl;
		return;
	}
	function dotoggle() {
		  for(var i = 0; i < document.f.elements.length; i++) {
			if(document.f.elements[i].type=='checkbox') {
			    	if( document.f.elements[i].name.substr( 0, 3 ) == 'shf') {
					document.f.elements[i].checked = !(document.f.elements[i].checked);
    				}	
			}
  		}
	}
	function doreload() {
		document.f.action.value='reload';
		document.f.submit();
	}
	function doexec1() {
		var cmd=document.f.d1.value;
		document.f.action.value=cmd;
		document.f.submit();
	}
	function doexec2() {
		var cmd=document.f.d2.value;
		document.f.action.value=cmd;
		document.f.submit();
	}
//--></script>
</head>
<body bgcolor="#888888" leftmargin="0" topmargin="0" marginwidth="0" marginheight="0" onload="initjsDOMenu();">
<!-- start console win -->
<center>
<table bgcolor="#eeeeee" height="100%" width="100%" border="0" cellpadding="0" cellspacing="0" class="block0">
<tr valign="top">
<td align="center">	
<table bgcolor="#005a8f" width="100%" border="0" cellpadding="2" cellspacing="0">
<tr valign="center">
<td height="18" align="left" class="td_label" width=10><img src="png.so?path=image&image=online.gif" border=0 alt="<?get_online();?>"></td>
<td height="18" align="left" class="td_label">&nbsp;IDS Configuration - Manage Signatures</td>
<td height="18" align="right"><a href="blank.so"><img src="png.so?path=image&image=close.png" border="0"></a></td>
</tr>
</table>
<table bgcolor="#d4d0c8" width="100%" height="18" border="0" cellpadding="0" cellspacing="0">
<tr valign="center">
<td>
<form name=d>
<nobr>
<input type=button value="Blocking Setup" class=input_button onclick="load('ids0.so');"><input type=button value="Signature Info" class=input_button onclick="load('ids1.so');"><input type=button value="Manage Signatures" class=input_button onclick="load('ids2.so');"></nobr>
</td>
</tr>
<tr><td></form></td></tr>
</table>



<table bgcolor="#eeeeee" width="100%" height="100%" border="0" cellpadding="1" cellspacing="1" class="block">
<tr valign="top">
<td align=center><br><br>

<form name=f action=ids2.so method=post>
    <table cellpadding="5" border="0" cellspacing="0" align="center">
    <tr>

        <td valign="top" width="600" align=center>
            <fieldset>
                <legend>Manage Signatures</legend><br>
                <table border="0" cellspacing="1" cellpadding="0">
	<tr>
	<td align=right><select name=rl size=1" class=input_text onchange="doselect1();"><option value=''>-------- select --------</option>
	<?

		if($handle = opendir("/hd/idsconf/rules")) { 
			while(($file = readdir($handle)) !== false) {  
				$select='';
       				if($file != "." && $file != "..") {
           				if(preg_match("/(.*).sig/",$file)) {
						if($file=="$dofile") $select='selected';
						echo "<option value=\"$file\" $select>$file</option>";
					}	 
       				}	 
  			}
			closedir($handle);
		}
	?>
	</select>&nbsp;&nbsp;&nbsp;<input type=button value="Reload" class=input_button onclick="doreload();">&nbsp;<input type=button value="Execute" class=input_button onclick="doexec1();"><select name=d1 size=1 class=input_button><option value='active'>active</option><option value='noactive'>deactive</option><option value='drop'>drop</option><option value='nodrop'>nodrop</option><option value='delete'>delete</option></select><input type=button value="Toggle" class=input_button onclick="dotoggle();">
	</td>
	</tr>
	<tr><td></td></tr>
                    <tr>
                        <td>
                               <table width="550" border="0" cellpadding="1" cellspacing="1" class=block>

      <tr bgcolor="#6696bc"> 
        <td width=10 class=td_pad>Id</td>
        <td class=td_pad>Events</td>
        <td width=10 class=td_pad>Drop</td>
        <td width=10 class=td_pad>Active</td>
        <td width=10 class=td_pad>Opt</td>
      </tr>
	<?
		if(file_exists("/hd/idsconf/rules/$dofile")) {
			$buff=file("/hd/idsconf/rules/$dofile");
			$cnt='0';
			$drop='0';
			$active='0';
			foreach($buff as $line) {
                                if($line!='') {
                                        if(preg_match("/msg:(.*);/",$line,$pp)) {
                                        	list($msg,$rest)=preg_split("/;/",$pp[1]);
						$msg=trim($msg,'"');
						$msg=str_replace('\\','',$msg);
						if(preg_match("/(\d):(\d)\s+(.*)/",$msg,$rk)) {
							$drop=$rk[1];
							$active=$rk[2];
							$msg=$rk[3];
						}
						$image[0]='png.so?path=image&image=no.png';
						$image[1]='png.so?path=image&image=yes.png';
					}

					echo "
      					<tr bgcolor=\"#E7E9F2\"> 
        				<td class=td_pad>$cnt</td>
        				<td class=td_pad>$msg</td>
        				<td align=center class=td_pad><a href=\"ids2.so?ch0=1&fl=$dofile&drop=$drop&line=$cnt\"><img src=\"$image[$drop]\" border=0></td>
        				<td align=center class=td_pad><a href=\"ids2.so?ch0=2&fl=$dofile&active=$active&line=$cnt\"><img src=\"$image[$active]\" border=0></a></td>
        				<td align=center class=td_pad><input type=checkbox name=shf[$cnt] value=$cnt></td>
      					</tr>
					";
				}
			$cnt++;
			}
		}
	clearstatcache();
	?>

</table>

<tr><td></td></tr>
	<tr>
	<td align=right></td>
	</tr>

                     </tr>
                        </td>
                    </tr>

          
         </td>
    </tr>

	<tr>
	<td align=right><select name=rl2 size=1" class=input_text onchange="doselect2();"><option value=''>-------- select --------</option>
	<?

		if($handle = opendir("/hd/idsconf/rules")) { 
			while(($file = readdir($handle)) !== false) {  
				$select='';
       				if($file != "." && $file != "..") {
           				if(preg_match("/(.*).sig/",$file)) {
						if($file=="$dofile") $select='selected';
						echo "<option value=\"$file\" $select>$file</option>";
					}	 
       				}	 
  			}
			closedir($handle);
		}
	?>
	</select>&nbsp;&nbsp;&nbsp;<input type=button value="Reload" class=input_button onclick="doreload();">&nbsp;<input type=button value="Execute" class=input_button onclick="doexec2();"><select name=d2 size=1 class=input_button><option value='active'>active</option><option value='noactive'>deactive</option><option value='drop'>drop</option><option value='nodrop'>nodrop</option><option value='delete'>delete</option></select><input type=button value="Toggle" class=input_button onclick="dotoggle();">
	</td>
	</tr>

    </table><br>
  </fieldset>
<input type=hidden name=action value=''>
<input type=hidden name=ff value='<?echo $dofile;?>'>
</form>

</td>
</tr>
</table>

</td>
</tr>
</table>
</center>
<!-- end console win -->
</body>
</html>
<? unset($dofile); flush(); ?>
