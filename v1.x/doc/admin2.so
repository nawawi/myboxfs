#!/bin/php
<?
//
// Mybox Firewall - A Firewall Appliance
// http://www.mybox.net.my/
//
// (C) Copyright 2002,2003,2004 Mohd Nawawi Mohamad Jamili, TraceNetwork Corporation Sdn. Bhd.
//
// This program is not free software; you cannot redistribute it and/or
// modify without permission copyright owner.
//
// This code is protected by copyright law and international treaties. 
// Unauthorized reproduction or distribution of this program, or any portion of it, 
// may result in severe civil and criminal penalties, and will be prosecuted to the 
// maximum extent possible under the law.
//
// $Id: admin2.so,v 1.00 2003/07/28 1:07 AM nawawi Exp $
//
	include_once('scripts/functions.inc');
	include_once('scripts/auth.inc');
	include_once('scripts/mail.inc');

	$_ACCESS=chk_session();
	if($_ACCESS=='' || is_admin($_ACCESS)) {
		write_userlog('Accessing Admin -> Password Setup page','Access denied');
		go_exit();
	}
	if(is_admin($_ACCESS)) {
		write_userlog('Accessing Admin -> Password Setup page','Access denied -> Not Admin');
		echo "you're on candid camera..";
		exit;
	}
	// Do
	if(isset($do)&& $do=='1') {
		$admpass=get_ini('MINISERV','ADMIN');
		$lookpass=get_ini('MINISERV','LOOK');
		if($admpass0!='' && $admpass1!='' && $admpass2!='') {
			$admpass0=md5(crypt($admpass0,$admpass0));
			if($admpass==$admpass0) {
				if($admpass1==$admpass2) {
					write_userlog('Executing Admin -> Password Setup -> changepass admin','Action granted');
					system_alert("$_ACCESS",'Change password for admin privilege. Action granted');
					$admpass=md5(crypt($admpass1,$admpass2));
					write_ini('MINISERV','ADMIN',$admpass);				
				}
			} else {
				$MSG="Current Password for Admin privilege not match.";
				write_userlog('Executing Admin -> Password Setup -> changepass admin','Action denied -> not match');
				unset($do,$action,$admpass0,$admpass1,$admpass2,$lookpass0,$lookpass1);
				header("Location: admin_msg.so?ref=admin2.so&msg=$MSG");
				exit;
			}
		}
		if($lookpass0!='' && $lookpass1!='') {
			if($lookpass0==$lookpass1) {
				$lookpass=md5(crypt($lookpass0,$lookpass1));
				if($lookpass!=$admpass) {
					write_userlog('Executing Admin -> Password Setup -> changepass look','Action granted');
					system_alert("$_ACCESS",'Change password for look privilege. Action granted');
					write_ini('MINISERV','LOOK',$lookpass);
				} else {
					$MSG="Password for Look privilege same with Admin privilege. Plese choose other password";
					write_userlog('Executing Admin -> Password Setup -> changepass admin','Action denied -> restricted');
					unset($do,$action,$admpass0,$admpass1,$admpass2,$lookpass0,$lookpass1);
					header("Location: admin_msg.so?ref=admin2.so&msg=$MSG");
					exit;
				}
			}
		}
		unset($do,$action,$admpass0,$admpass1,$admpass2,$lookpass0,$lookpass1);
		write_userlog('Executing Admin -> Password Setup -> updating password','Action granted');
		header("Location: admin_msg.so?ref=admin2.so&msg=Please wait.. updating Password..");
		exit;
	}
	write_userlog('Accessing Admin -> Password Setup page','Access granted');
	write_nocache();
?>
<?include_once('scripts/header.inc');?>
<html>
<head>
<title>MyBox Firewall</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<?include_once('scripts/style.css');?>
<?include_once('scripts/global.js');?>
<script language="javascript1.2"><!--
	defaultStatus="Password Setup";
	function dosubmit() {
		var admpass0=document.f.admpass0.value;
		var admpass1=document.f.admpass1.value;
		var admpass2=document.f.admpass2.value;
		var lookpass0=document.f.lookpass0.value;
		var lookpass1=document.f.lookpass1.value;
		var lookchange='1';
		var admchange='1';
		if(admpass0=='' && admpass1=='' && admpass2=='') {
			admchange='0';
		}
		if(lookpass0=='' && lookpass0=='') {
			lookchange='0';
		}
		if(admchange=='1') {
			if(admpass1!=admpass2) {
				alert('Admin Privilege Password not match');
				document.f.admpass0.value='';
				document.f.admpass1.value='';
				document.f.admpass2.value='';
				document.f.admpass0.focus();
				return false;
			}
			if(admpass1.length < '6') {
				alert('Admin Privilege Password must be 6 character length');
				document.f.admpass0.value='';
				document.f.admpass1.value='';
				document.f.admpass2.value='';
				document.f.admpass0.focus();
				return false;
			}
			admchange='2';
		}
		
		if(lookchange=='1') {
			if(lookpass0!=lookpass1) {
				alert('Look Privilege Password not match');
				document.f.lookpass0.value='';
				document.f.lookpass1.value='';
				document.f.lookpass0.focus();
				return false;
			}
			if(lookpass1.length < '6') {
				alert('Look Privilege Password must be 6 character length');
				document.f.lookpass0.value='';
				document.f.lookpass1.value='';
				document.f.lookpass0.focus();
				return false;
			}
			lookchange='2';
		}
		if(admchange=='2' | lookchange=='2') {
			document.f.submit();
			return true;
		}
	}
//--></script>
</head>
<body bgcolor="#888888" leftmargin="0" topmargin="0" marginwidth="0" marginheight="0" onload="document.f.admpass0.focus();initjsDOMenu();">
<!-- start console win -->
<center>
<table bgcolor="#eeeeee" height="100%" width="100%" border="0" cellpadding="0" cellspacing="0" class="block0">
<tr valign="top">
<td align="center">	
<table bgcolor="#005a8f" width="100%" border="0" cellpadding="2" cellspacing="0">
<tr valign="center">
<td height="18" align="left" class="td_label" width=10><img src="png.so?path=image&image=online.gif" border=0 alt="<?get_online();?>"></td>
<td height="18" align="left" class="td_label">&nbsp;Administration - Password Setup</td>
<td height="18" align="right"><a href="blank.so"><img src="png.so?path=image&image=close.png" border="0"></a></td>
</tr>
</table>
<table bgcolor="#d4d0c8" width="100%" height="18" border="0" cellpadding="0" cellspacing="0">
<tr valign="center">
<td>
<form>
<nobr>
<?if(!is_admin($_ACCESS)){?><input type=button value="WebAdmin Setup" class=input_button onclick="load('admin0.so');"><?}?><input type=button value="Backup/Restore" class=input_button onclick="load('admin1.so');"><input type=button value="Remote Backup" class=input_button onclick="load('admin4.so');"><?if(!is_admin($_ACCESS)){?><input type=button value="Password Setup" class=input_button onclick="load('admin2.so');"><input type=button value="Alarm Setup" class=input_button onclick="load('admin3.so');"><?}?>
</nobr>
</td>
</tr>
<tr><td></form></td></tr>
</table>


<table bgcolor="#eeeeee" width="100%" height="100%" border="0" cellpadding="1" cellspacing="1" class="block">
<tr valign="top">
<td align=center><br><br>

<form name=f action=admin2.so?do=1 method=post>
<table border="0" cellspacing="0" align="center">
<tr>
<td nowrap="nowrap" align=center valign="top">
<fieldset>
<legend>Password For Admin Privilege</legend>
<table border="0" cellspacing="1" cellpadding="0" bgcolor="#E7E9F2">
<tr>
                        <td>
                            Current Password&nbsp;&nbsp;&nbsp;&nbsp;
                        </td>
                        <td class=td_tab bgcolor="#E7E9F2">
			<input type="password" name="admpass0" size="15" value="" class="input_text">
                        </td>
                    </tr>
                    <tr>
                        <td>
                            New Password&nbsp;&nbsp;&nbsp;&nbsp;
                        </td>
                        <td class=td_tab bgcolor="#E7E9F2">
			<input type="password" name="admpass1" size="15" value="" class="input_text">
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Retype Password&nbsp;&nbsp;&nbsp;&nbsp;
                        </td>
                        <td class=td_tab bgcolor="#E7E9F2">
                            <input type="password" name="admpass2" size="15" value="" class="input_text">
                        </td>
                    </tr>

</table>
</fieldset>
</td>
<td valign=top align=center>
<fieldset>
<legend>Password For Look Privilege</legend>
<table border="0" cellspacing="1" cellpadding="0" bgcolor="#E7E9F2">

                       <tr>
                        <td>
                            New Password&nbsp;&nbsp;&nbsp;&nbsp;
                        </td>
                        <td class=td_tab bgcolor="#E7E9F2">
			<input type="password" name="lookpass0" size="15" value="" class="input_text">
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Retype Password&nbsp;&nbsp;&nbsp;&nbsp;
                        </td>
                        <td class=td_tab bgcolor="#E7E9F2">
                            <input type="password" name="lookpass1" size="15" value="" class="input_text">
                        </td>
                    </tr>
</table>

</td>
</tr>
    <tr>
        <td colspan="2" align="center">
            <input type="button" value="Cancel" class="input_button" onclick="load('admin.so');"><input type="button" value="Save This Setting" class="input_button" onclick="return dosubmit();">
        </td>
    </tr>
</table>
</form>
</td>
</tr>
</table>
</center>
<!-- end console win -->
</body>
</html>

<? flush(); ?>
