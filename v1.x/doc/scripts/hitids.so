#!/bin/php -q
<?
//
// Mybox Firewall - A Firewall Appliance
// http://www.mybox.net.my/
//
// (C) Copyright 2002,2003,2004 Mohd Nawawi Mohamad Jamili, TraceNetwork Corporation Sdn. Bhd.
//
// This program is not free software; you cannot redistribute it and/or
// modify without permission copyright owner.
//
// This code is protected by copyright law and international treaties. 
// Unauthorized reproduction or distribution of this program, or any portion of it, 
// may result in severe civil and criminal penalties, and will be prosecuted to the 
// maximum extent possible under the law.
//
// $Id: hitids.so,v 1.00 2003/07/28 1:07 AM nawawi Exp $
//


	set_time_limit(0);

	if(file_exists('functions.inc')) {
		include_once('functions.inc');
	} elseif(file_exists('scripts/functions.inc')) {
		include_once('scripts/functions.inc');
	} else {
		include_once('/usr/miniserv/scripts/functions.inc');
	}

	if(!file_exists('/usr/bin/rrdtool')) exit("ERROR: /usr/bin/rrdtool not exist\n");

	$logdir=get_ini('IDS','REPORT');
	$datadir=get_ini('GRAPH','DATADIR');
	$imgdir=get_ini('GRAPH','IMGDIR');

	if(!is_dir($datadir)) {
		shell_exec("mkdir -p $datadir");
	}

	if(!is_dir($imgdir)) {
		shell_exec("mkdir -p $imgdir");
	}
	chmod($datadir,0700);
	chmod($imgdir,0700);

	if(!is_dir($logdir)) {
		exit;
	}
	$date=date('y-m-d');
	$logp="$date"."-p.log";
	$loga="$date"."-a.log";
	if(!file_exists("$logdir/$logp")) {
		$pcnt='0';
	} else {
		$fi=file("$logdir/$logp");
		$pcnt=count($fi)-1;
	}
	if(!file_exists("$logdir/$loga")) {
		$acnt='0';
	} else {
		$fi=file("$logdir/$loga");
		$acnt=count($fi)-1;
	}

	$hits=$acnt + $pcnt;

	// create rra
	if(!file_exists("$datadir/ids.rrd")) {
		shell_exec("/usr/bin/rrdtool create $datadir/ids.rrd --step 300 DS:idsalert:DERIVE:600:0:100000 RRA:AVERAGE:0.5:1:600 RRA:AVERAGE:0.5:6:700 RRA:AVERAGE:0.5:24:775 RRA:AVERAGE:0.5:288:797 RRA:MAX:0.5:1:600 RRA:MAX:0.5:6:700 RRA:MAX:0.5:24:775 RRA:MAX:0.5:288:797");
	}
	$date=date('d/m/Y - h:i:s a');
	
	// update
	shell_exec("/usr/bin/rrdtool update $datadir/ids.rrd --template idsalert N:$hits");
	shell_exec("/usr/bin/rrdtool tune $datadir/ids.rrd --minimum idsalert:0");

	// preview
	shell_exec("/usr/bin/rrdtool graph $imgdir/idshits0.png --imgformat=PNG --start=\"-60000\" --title=\"IDS ATTACK ALERT HITS\" --rigid --base=1024 --height=100 --width=300 --alt-autoscale --units-exponent=0 --vertical-label=\"Hits\" DEF:a=\"$datadir/ids.rrd\":idsalert:AVERAGE CDEF:cdefa=a,300,\* AREA:cdefa#7EE600");

	// daily 5 Minutes
	shell_exec("/usr/bin/rrdtool graph $imgdir/idshits1.png --imgformat=PNG --start=\"-86400\" --title=\"DAILY IDS ATTACK ALERT HITS\" --rigid --base=1024 --height=150 --width=500 --alt-autoscale --units-exponent=0 --vertical-label=\"Hits\" DEF:a=\"$datadir/ids.rrd\":idsalert:AVERAGE CDEF:cdefa=a,300,\* AREA:cdefa#7EE600:\"Attack Hits -\" GPRINT:cdefa:LAST:\"Current\\:%8.0lf\" GPRINT:cdefa:AVERAGE:\"Average\\:%8.0lf %s\" GPRINT:cdefa:MAX:\"Maximum\\:%8.0lf\\n\" COMMENT:\"\\n\" COMMENT:\"$date - Hits 5 Minutes Average\\n\"");

	// weekly 30 Minutes
	shell_exec("/usr/bin/rrdtool graph $imgdir/idshits2.png --imgformat=PNG --start=\"-604800\" --title=\"WEEKLY IDS ATTACK ALERT HITS\" --rigid --base=1024 --height=150 --width=500 --alt-autoscale --units-exponent=0 --vertical-label=\"Hits\" DEF:a=\"$datadir/ids.rrd\":idsalert:AVERAGE CDEF:cdefa=a,300,\* AREA:cdefa#7EE600:\"Attack Hits -\" GPRINT:cdefa:LAST:\"Current\\:%8.0lf\" GPRINT:cdefa:AVERAGE:\"Average\\:%8.0lf\" GPRINT:cdefa:MAX:\"Maximum\\:%8.0lf\\n\" COMMENT:\"\\n\" COMMENT:\"$date - Hits 30 Minutes Average\\n\"");

	// monthly 2 Hours
	shell_exec("/usr/bin/rrdtool graph $imgdir/idshits3.png --imgformat=PNG --start=\"-2678400\" --title=\"MONTHLY IDS ATTACK ALERT HITS\" --rigid --base=1024 --height=150 --width=500 --alt-autoscale --units-exponent=0 --vertical-label=\"Hits\" DEF:a=\"$datadir/ids.rrd\":idsalert:AVERAGE CDEF:cdefa=a,300,\* AREA:cdefa#7EE600:\"Attack Hits -\" GPRINT:cdefa:LAST:\"Current\\:%8.0lf\" GPRINT:cdefa:AVERAGE:\"Average\\:%8.0lf\" GPRINT:cdefa:MAX:\"Maximum\\:%8.0lf\\n\" COMMENT:\"\\n\" COMMENT:\"$date - Hits 2 Hours Average\\n\"");

	// yearly 1 day
	shell_exec("/usr/bin/rrdtool graph $imgdir/idshits4.png --imgformat=PNG --start=\"-33053184\" --title=\"YEARLY IDS ATTACK ALERT HITS\" --rigid --base=1024 --height=150 --width=500 --alt-autoscale --units-exponent=0 --vertical-label=\"Hits\" DEF:a=\"$datadir/ids.rrd\":idsalert:AVERAGE CDEF:cdefa=a,300,\* AREA:cdefa#7EE600:\"Attack Hits -\" GPRINT:cdefa:LAST:\"Current\\:%8.0lf\" GPRINT:cdefa:AVERAGE:\"Average\\:%8.0lf\" GPRINT:cdefa:MAX:\"Maximum\\:%8.0lf\\n\" COMMENT:\"\\n\" COMMENT:\"$date - Hits 1 Day Average\\n\"");

	flush();
?>

