#!/bin/php -q
<?
//
// Mybox Firewall - A Firewall Appliance
// http://www.mybox.net.my/
//
// (C) Copyright 2002,2003,2004 Mohd Nawawi Mohamad Jamili, TraceNetwork Corporation Sdn. Bhd.
//
// This program is not free software; you cannot redistribute it and/or
// modify without permission copyright owner.
//
// This code is protected by copyright law and international treaties. 
// Unauthorized reproduction or distribution of this program, or any portion of it, 
// may result in severe civil and criminal penalties, and will be prosecuted to the 
// maximum extent possible under the law.
//
// $Id: freemem.so,v 1.00 2003/07/28 1:07 AM nawawi Exp $
//



	if(!file_exists('/proc/meminfo')) exit;
	set_time_limit(0);
	if(file_exists('functions.inc')) {
		include_once('functions.inc');
	} elseif(file_exists('scripts/functions.inc')) {
		include_once('scripts/functions.inc');
	} else {
		include_once('/usr/miniserv/scripts/functions.inc');
	}
	if(!file_exists('/usr/bin/rrdtool')) exit("ERROR: /usr/bin/rrdtool not exist\n");

	$memfree='0';
	$membuff='0';

	$datadir=get_ini('GRAPH','DATADIR');
	$imgdir=get_ini('GRAPH','IMGDIR');

	if(!is_dir($datadir)) {
		shell_exec("mkdir -p $datadir");
	}

	if(!is_dir($imgdir)) {
		shell_exec("mkdir -p $imgdir");
	}
	chmod($datadir,0700);
	chmod($imgdir,0700);

	$memfree='0';
	$membuff='0';
	if(file_exists('/proc/meminfo')) {
		$handle=fopen('/proc/meminfo','r');
		while($buff=fgets($handle,151)) {
			$buff=trim($buff);
			if($buff!='') {
				if(preg_match("/^MemFree:\s+(\d+)\s*kB$/",$buff,$mem)) {
					$memfree=$mem[1];
				}
				if(preg_match("/^Buffers:\s+(\d+)\s*kB$/",$buff,$mem)) {
					$membuff=$mem[1];
				}
			}
		}
		fclose($handle);
	}

	// create rra
	if(!file_exists("$datadir/freemem.rrd")) {
		shell_exec("/usr/bin/rrdtool create $datadir/freemem.rrd --step 300 DS:system_mem_free:GAUGE:600:0:10000000 RRA:AVERAGE:0.5:1:600 RRA:AVERAGE:0.5:6:700 RRA:AVERAGE:0.5:24:775 RRA:AVERAGE:0.5:288:797 RRA:MAX:0.5:1:600 RRA:MAX:0.5:6:700 RRA:MAX:0.5:24:775 RRA:MAX:0.5:288:797");
	}

	if(!file_exists("$datadir/$membuff.rrd")) {
		shell_exec("/usr/bin/rrdtool create $datadir/freebuff.rrd --step 300 DS:system_mem_buffers:GAUGE:600:0:10000000 RRA:AVERAGE:0.5:1:600 RRA:AVERAGE:0.5:6:700 RRA:AVERAGE:0.5:24:775 RRA:AVERAGE:0.5:288:797 RRA:MAX:0.5:1:600 RRA:MAX:0.5:6:700 RRA:MAX:0.5:24:775 RRA:MAX:0.5:288:797");
	}

	$date=date('d/m/Y - h:i:s a');

	// update
	shell_exec("/usr/bin/rrdtool update $datadir/freemem.rrd --template system_mem_free N:$memfree");
	shell_exec("/usr/bin/rrdtool update $datadir/freebuff.rrd --template system_mem_buffers N:$membuff");

	// preview
	shell_exec("/usr/bin/rrdtool graph $imgdir/freemem0.png --imgformat=PNG --start=\"-60000\" --title=\"MEMORY FREE USAGE\" --rigid --base=1024 --height=100 --width=300 --alt-autoscale-max --vertical-label=\"Memory\" DEF:a=\"$datadir/freemem.rrd\":system_mem_free:AVERAGE DEF:b=\"$datadir/freebuff.rrd\":system_mem_buffers:AVERAGE AREA:a#99CCFF STACK:b#3366FF");

	// daily 5 Minutes
	shell_exec("/usr/bin/rrdtool graph $imgdir/freemem1.png --imgformat=PNG --start=\"-86400\" --title=\"DAILY MEMORY FREE USAGE\" --rigid --base=1024 --height=150 --width=500 --alt-autoscale-max --vertical-label=\"Memory\" DEF:a=\"$datadir/freemem.rrd\":system_mem_free:AVERAGE DEF:b=\"$datadir/freebuff.rrd\":system_mem_buffers:AVERAGE AREA:a#99CCFF:\"Memory Free\\: $memfree kB -\" STACK:b#3366FF:\"Memory Buffers\\: $membuff kB\\n\" COMMENT:\"\\n\" COMMENT:\"$date - Usage 5 Minutes Average\\n\"");

	// weekly 30 Minutes
	shell_exec("/usr/bin/rrdtool graph $imgdir/freemem2.png --imgformat=PNG --start=\"-604800\" --title=\"WEEKLY MEMORY FREE USAGE\" --rigid --base=1024 --height=150 --width=500 --alt-autoscale-max --vertical-label=\"Memory\" DEF:a=\"$datadir/freemem.rrd\":system_mem_free:AVERAGE DEF:b=\"$datadir/freebuff.rrd\":system_mem_buffers:AVERAGE AREA:a#99CCFF:\"Memory Free\\: $memfree kB -\" STACK:b#3366FF:\"Memory Buffers\\: $membuff kB\\n\" COMMENT:\"\\n\" COMMENT:\"$date - Usage 30 Minutes Average\\n\"");

	// monthly 2 Hours
	shell_exec("/usr/bin/rrdtool graph $imgdir/freemem3.png --imgformat=PNG --start=\"-2678400\" --title=\"MONTHLY MEMORY FREE USAGE\" --rigid --base=1024 --height=150 --width=500 --alt-autoscale-max --vertical-label=\"Memory\" DEF:a=\"$datadir/freemem.rrd\":system_mem_free:AVERAGE DEF:b=\"$datadir/freebuff.rrd\":system_mem_buffers:AVERAGE AREA:a#99CCFF:\"Memory Free\\: $memfree kB -\" STACK:b#3366FF:\"Memory Buffers\\: $membuff kB\\n\" COMMENT:\"\\n\" COMMENT:\"$date - Usage 2 Hours Average\\n\"");

	// yearly 1 day
	shell_exec("/usr/bin/rrdtool graph $imgdir/freemem4.png --imgformat=PNG --start=\"-33053184\" --title=\"YEARLY MEMORY FREE USAGE\" --rigid --base=1024 --height=150 --width=500 --alt-autoscale-max --vertical-label=\"Memory\" DEF:a=\"$datadir/freemem.rrd\":system_mem_free:AVERAGE DEF:b=\"$datadir/freebuff.rrd\":system_mem_buffers:AVERAGE AREA:a#99CCFF:\"Memory Free\\: $memfree kB -\" STACK:b#3366FF:\"Memory Buffers\\: $membuff kB\\n\" COMMENT:\"\\n\" COMMENT:\"$date - Usage 1 Day Average\\n\"");


?>
