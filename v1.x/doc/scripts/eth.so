#!/bin/php -q
<?
//
// Mybox Firewall - A Firewall Appliance
// http://www.mybox.net.my/
//
// (C) Copyright 2002,2003,2004 Mohd Nawawi Mohamad Jamili, TraceNetwork Corporation Sdn. Bhd.
//
// This program is not free software; you cannot redistribute it and/or
// modify without permission copyright owner.
//
// This code is protected by copyright law and international treaties. 
// Unauthorized reproduction or distribution of this program, or any portion of it, 
// may result in severe civil and criminal penalties, and will be prosecuted to the 
// maximum extent possible under the law.
//
// $Id: eth.so,v 1.00 2003/07/28 1:07 AM nawawi Exp $
//

	set_time_limit(0);
	if(file_exists('functions.inc')) {
		include_once('functions.inc');
	} elseif(file_exists('scripts/functions.inc')) {
		include_once('scripts/functions.inc');
	} else {
		include_once('/usr/miniserv/scripts/functions.inc');
	}
	if(!file_exists('/usr/bin/rrdtool')) exit("ERROR: /usr/bin/rrdtool not exist\n");

	function create_db($path,$file,$name) {
		if(!file_exists("$path/$file")) {
			shell_exec("/usr/bin/rrdtool create $path/$file --step 300 DS:$name:DERIVE:600:0:100000000 RRA:AVERAGE:0.5:1:600 RRA:AVERAGE:0.5:6:700 RRA:AVERAGE:0.5:24:775 RRA:AVERAGE:0.5:288:797 RRA:MAX:0.5:1:600 RRA:MAX:0.5:6:700 RRA:MAX:0.5:24:775 RRA:MAX:0.5:288:797");
		}
	}

	function update_db($path,$file,$value,$ds) {
		shell_exec("/usr/bin/rrdtool update $path/$file --template $ds N:$value");
		shell_exec("/usr/bin/rrdtool tune $path/$file --minimum $ds:0");
	}

	function create_preview($imgdir,$png,$title,$label,$datadir,$rrain,$inname,$rraout,$outname) {
		shell_exec("/usr/bin/rrdtool graph $imgdir/$png --imgformat=PNG --start=\"-60000\" --title=\"$title\" --rigid --base=1000 --height=100 --width=300 --alt-autoscale-max --vertical-label=\"$label\" DEF:a=\"$datadir/$rrain\":$inname:AVERAGE DEF:b=\"$datadir/$rraout\":$outname:AVERAGE AREA:a#00CF00 LINE1:b#002A97");
	}

	function create_graph($time,$imgdir,$png,$title,$label,$datadir,$rrain,$inname,$rraout,$outname,$gtitle) {
		$date=date('d/m/Y - h:i:s a');
		shell_exec("/usr/bin/rrdtool graph $imgdir/$png --imgformat=PNG --start=\"-$time\" --title=\"$title\" --rigid --base=1000 --height=120 --width=500 --alt-autoscale-max --vertical-label=\"$label\" DEF:a=\"$datadir/$rrain\":$inname:AVERAGE DEF:b=\"$datadir/$rraout\":$outname:AVERAGE AREA:a#00CF00:\"Inbound\" GPRINT:a:LAST:\" Current\\:%8.2lf %s\" GPRINT:a:AVERAGE:\"Average\\:%8.2lf %s\" GPRINT:a:MAX:\"Maximum\\:%8.2lf %s\\n\" LINE1:b#002A97:\"Outbound\" GPRINT:b:LAST:\"Current\\:%8.2lf %s\" GPRINT:b:AVERAGE:\"Average\\:%8.2lf %s\" GPRINT:b:MAX:\"Maximum\\:%8.2lf %s\" COMMENT:\"\\n\" COMMENT:\"\\n\" COMMENT:\"$date - Traffic $gtitle\"");
	}

	$datadir=get_ini('GRAPH','DATADIR');
	$imgdir=get_ini('GRAPH','IMGDIR');
	$community=get_ini('SNMP','COMMUNITY');
	$snmphost=get_ini('SNMP','HOST');
	if($community=='NULL') exit;

	if(!is_dir($datadir)) {
		shell_exec("mkdir -p $datadir");
	}

	if(!is_dir($imgdir)) {
		shell_exec("mkdir -p $imgdir");
	}
	chmod($datadir,0700);
	chmod($imgdir,0700);

	$cmd="/usr/bin/snmpwalk $snmphost $community";

	// eth0in
	$handle=popen("$cmd interfaces.ifTable.ifEntry.ifInOctets.2",'r');
	$buff=fread($handle,2096);
	pclose($handle);

	$eth0inval='0';
	if(preg_match("/(.*)=\s+Counter32:\s+(.*)/",$buff,$match)) {
		$eth0inval=$match[2];
	}

	// eth0out
	$handle=popen("$cmd interfaces.ifTable.ifEntry.ifOutOctets.2",'r');
	$buff=fread($handle,2096);
	pclose($handle);

	$eth0outval='0';
	if(preg_match("/(.*)=\s+Counter32:\s+(.*)/",$buff,$match)) {
		$eth0outval=$match[2];
	}

	// eth1in
	$handle=popen("$cmd interfaces.ifTable.ifEntry.ifInOctets.3",'r');
	$buff=fread($handle,2096);
	pclose($handle);

	$eth1inval='0';
	if(preg_match("/(.*)=\s+Counter32:\s+(.*)/",$buff,$match)) {
		$eth1inval=$match[2];
	}

	// eth1out
	$handle=popen("$cmd interfaces.ifTable.ifEntry.ifOutOctets.3",'r');
	$buff=fread($handle,2096);
	pclose($handle);

	$eth1outval='0';
	if(preg_match("/(.*)=\s+Counter32:\s+(.*)/",$buff,$match)) {
		$eth1outval=$match[2];
	}

	// eth2in
	$handle=popen("$cmd interfaces.ifTable.ifEntry.ifInOctets.4",'r');
	$buff=fread($handle,2096);
	pclose($handle);

	$eth2outval='0';
	if(preg_match("/(.*)=\s+Counter32:\s+(.*)/",$buff,$match)) {
		$eth2inval=$match[2];
	}

	// eth2out
	$handle=popen("$cmd interfaces.ifTable.ifEntry.ifOutOctets.4",'r');
	$buff=fread($handle,2096);
	pclose($handle);

	$eth2outval='0';
	if(preg_match("/(.*)=\s+Counter32:\s+(.*)/",$buff,$match)) {
		$eth2outval=$match[2];
	}

	// eth3in
	$handle=popen("$cmd interfaces.ifTable.ifEntry.ifInOctets.5",'r');
	$buff=fread($handle,2096);
	pclose($handle);

	$eth3inval='0';
	if(preg_match("/(.*)=\s+Counter32:\s+(.*)/",$buff,$match)) {
		$eth3inval=$match[2];
	}

	// eth3out
	$handle=popen("$cmd interfaces.ifTable.ifEntry.ifOutOctets.5",'r');
	$buff=fread($handle,2096);
	pclose($handle);

	$eth3outval='0';
	if(preg_match("/(.*)=\s+Counter32:\s+(.*)/",$buff,$match)) {
		$eth3outval=$match[2];
	}
	// create rra
	create_db($datadir,'eth0in.rrd','eth0in');
	create_db($datadir,'eth0out.rrd','eth0out');
	create_db($datadir,'eth1in.rrd','eth1in');
	create_db($datadir,'eth1out.rrd','eth1out');
	create_db($datadir,'eth2in.rrd','eth2in');
	create_db($datadir,'eth2out.rrd','eth2out');
	create_db($datadir,'eth3in.rrd','eth3in');
	create_db($datadir,'eth3out.rrd','eth3out');

	// update rra
	update_db($datadir,'eth0in.rrd',$eth0inval,'eth0in');
	update_db($datadir,'eth0out.rrd',$eth0outval,'eth0out');

	update_db($datadir,'eth1in.rrd',$eth1inval,'eth1in');
	update_db($datadir,'eth1out.rrd',$eth1outval,'eth1out');

	update_db($datadir,'eth2in.rrd',$eth2inval,'eth2in');
	update_db($datadir,'eth2out.rrd',$eth2outval,'eth2out');

	update_db($datadir,'eth3in.rrd',$eth3inval,'eth3in');
	update_db($datadir,'eth3out.rrd',$eth3outval,'eth3out');

	// preview
	create_preview($imgdir,'eth00.png','EXTERNAL NETWORK','bytes persecond',$datadir,'eth0in.rrd','eth0in','eth0out.rrd','eth0out');
	create_preview($imgdir,'eth10.png','PRIMARY DMZ NETWORK','bytes persecond',$datadir,'eth1in.rrd','eth1in','eth1out.rrd','eth1out');
	create_preview($imgdir,'eth20.png','SECONDARY DMZ NETWORK','bytes persecond',$datadir,'eth2in.rrd','eth2in','eth2out.rrd','eth2out');
	create_preview($imgdir,'eth30.png','SECURE NETWORK','bytes persecond',$datadir,'eth3in.rrd','eth3in','eth3out.rrd','eth3out');

	// daily 5 minutes
	create_graph('86400',$imgdir,'eth01.png','DAILY EXTERNAL NETWORK','bytes persecond',$datadir,'eth0in.rrd','eth0in','eth0out.rrd','eth0out','5 Minutes Average');
	create_graph('86400',$imgdir,'eth11.png','DAILY PRIMARY DMZ NETWORK','bytes persecond',$datadir,'eth1in.rrd','eth1in','eth1out.rrd','eth1out','5 Minutes Average');
	create_graph('86400',$imgdir,'eth21.png','DAILY SECONDARY DMZ NETWORK','bytes persecond',$datadir,'eth2in.rrd','eth2in','eth2out.rrd','eth2out','5 Minutes Average');
	create_graph('86400',$imgdir,'eth31.png','DAILY SECURE NETWORK','bytes persecond',$datadir,'eth3in.rrd','eth3in','eth3out.rrd','eth3out','5 Minutes Average');

	// weekly 30 minutes
	create_graph('604800',$imgdir,'eth02.png','WEEKLY EXTERNAL NETWORK','bytes persecond',$datadir,'eth0in.rrd','eth0in','eth0out.rrd','eth0out','30 Minutes Average');
	create_graph('604800',$imgdir,'eth12.png','WEEKLY PRIMARY DMZ NETWORK','bytes persecond',$datadir,'eth1in.rrd','eth1in','eth1out.rrd','eth1out','30 Minutes Average');
	create_graph('604800',$imgdir,'eth22.png','WEEKLY SECONDARY DMZ NETWORK','bytes persecond',$datadir,'eth2in.rrd','eth2in','eth2out.rrd','eth2out','30 Minutes Average');
	create_graph('604800',$imgdir,'eth32.png','WEEKLY SECURE NETWORK','bytes persecond',$datadir,'eth3in.rrd','eth3in','eth3out.rrd','eth3out','30 Minutes Average');

	// monthly 2 Hours
	create_graph('2678400',$imgdir,'eth03.png','MONTHLY EXTERNAL NETWORK','bytes persecond',$datadir,'eth0in.rrd','eth0in','eth0out.rrd','eth0out','2 Hours Average');
	create_graph('2678400',$imgdir,'eth13.png','MONTHLY PRIMARY DMZ NETWORK','bytes persecond',$datadir,'eth1in.rrd','eth1in','eth1out.rrd','eth1out','2 Hours Average');
	create_graph('2678400',$imgdir,'eth23.png','MONTHLY SECONDARY DMZ NETWORK','bytes persecond',$datadir,'eth2in.rrd','eth2in','eth2out.rrd','eth2out','2 Hours Average');
	create_graph('2678400',$imgdir,'eth33.png','MONTHLY SECURE NETWORK','bytes persecond',$datadir,'eth3in.rrd','eth3in','eth3out.rrd','eth3out','2 Hours Average');

	// yearly 1 day
	create_graph('33053184',$imgdir,'eth04.png','YEARLY EXTERNAL NETWORK','bytes persecond',$datadir,'eth0in.rrd','eth0in','eth0out.rrd','eth0out','1 Day Average');
	create_graph('33053184',$imgdir,'eth14.png','YEARLY PRIMARY DMZ NETWORK','bytes persecond',$datadir,'eth1in.rrd','eth1in','eth1out.rrd','eth1out','1 Day Average');
	create_graph('33053184',$imgdir,'eth24.png','YEARLY SECONDARY DMZ NETWORK','bytes persecond',$datadir,'eth2in.rrd','eth2in','eth2out.rrd','eth2out','1 Day Average');
	create_graph('33053184',$imgdir,'eth34.png','YEARLY SECURE NETWORK','bytes persecond',$datadir,'eth3in.rrd','eth3in','eth3out.rrd','eth3out','1 Day Average');

	// main preview
	// daily network 5 Minutes
	$date=date('d/m/Y - h:i:s a');
	shell_exec("/usr/bin/rrdtool graph $imgdir/eth012m.png --imgformat=PNG --start=\"-86400\" --title=\"DAILY NETWORK TRAFFIC GRAPH\" --rigid --base=1000 --height=120 --width=500 --alt-autoscale-max --vertical-label=\"bytes persecond\" DEF:a=\"$datadir/eth0in.rrd\":eth0in:AVERAGE DEF:b=\"$datadir/eth0out.rrd\":eth0out:AVERAGE COMMENT:\"\\n\" COMMENT:\"EXTERNAL NETWORK\\n\" LINE1:a#00CF00:\"Inbound\" GPRINT:a:LAST:\" Current\\:%8.2lf %s\" GPRINT:a:AVERAGE:\"Average\\:%8.2lf %s\" GPRINT:a:MAX:\"Maximum\\:%8.2lf %s\\n\" LINE1:b#002A97:\"Outbound\" GPRINT:b:LAST:\"Current\\:%8.2lf %s\" GPRINT:b:AVERAGE:\"Average\\:%8.2lf %s\" GPRINT:b:MAX:\"Maximum\\:%8.2lf %s\" COMMENT:\"\\n\" COMMENT:\"\\n\" COMMENT:\"PRIMARY DMZ NETWORK\\n\" DEF:c=\"$datadir/eth1in.rrd\":eth1in:AVERAGE DEF:d=\"$datadir/eth1out.rrd\":eth1out:AVERAGE LINE1:c#8F04FB:\"Inbound\" GPRINT:c:LAST:\" Current\\:%8.2lf %s\" GPRINT:c:AVERAGE:\"Average\\:%8.2lf %s\" GPRINT:c:MAX:\"Maximum\\:%8.2lf %s\\n\" LINE1:d#02B2FC:\"Outbound\" GPRINT:d:LAST:\"Current\\:%8.2lf %s\" GPRINT:d:AVERAGE:\"Average\\:%8.2lf %s\" GPRINT:d:MAX:\"Maximum\\:%8.2lf %s\" COMMENT:\"\\n\" COMMENT:\"\\n\" COMMENT:\"SECONDARY DMZ NETWORK\\n\" DEF:e=\"$datadir/eth2in.rrd\":eth2in:AVERAGE DEF:f=\"$datadir/eth2out.rrd\":eth2out:AVERAGE LINE1:e#BC044D:\"Inbound\" GPRINT:e:LAST:\" Current\\:%8.2lf %s\" GPRINT:e:AVERAGE:\"Average\\:%8.2lf %s\" GPRINT:e:MAX:\"Maximum\\:%8.2lf %s\\n\" LINE1:f#F888B5:\"Outbound\" GPRINT:f:LAST:\"Current\\:%8.2lf %s\" GPRINT:f:AVERAGE:\"Average\\:%8.2lf %s\" GPRINT:f:MAX:\"Maximum\\:%8.2lf %s\" COMMENT:\"\\n\" COMMENT:\"\\n\" COMMENT:\"SECURE NETWORK\\n\" DEF:g=\"$datadir/eth3in.rrd\":eth3in:AVERAGE DEF:h=\"$datadir/eth3out.rrd\":eth3out:AVERAGE LINE1:g#FCDC01:\"Inbound\" GPRINT:g:LAST:\" Current\\:%8.2lf %s\" GPRINT:g:AVERAGE:\"Average\\:%8.2lf %s\" GPRINT:g:MAX:\"Maximum\\:%8.2lf %s\\n\" LINE1:h#92982E:\"Outbound\" GPRINT:h:LAST:\"Current\\:%8.2lf %s\" GPRINT:h:AVERAGE:\"Average\\:%8.2lf %s\" GPRINT:h:MAX:\"Maximum\\:%8.2lf %s\" COMMENT:\"\\n\" COMMENT:\"\\n\" COMMENT:\"$date - Traffic 5 Minutes Average\\n\"");

	flush();
?>

