#!/bin/php
<?
//
// Mybox Firewall - A Firewall Appliance
// http://www.mybox.net.my/
//
// (C) Copyright 2002,2003,2004 Mohd Nawawi Mohamad Jamili, TraceNetwork Corporation Sdn. Bhd.
//
// This program is not free software; you cannot redistribute it and/or
// modify without permission copyright owner.
//
// This code is protected by copyright law and international treaties. 
// Unauthorized reproduction or distribution of this program, or any portion of it, 
// may result in severe civil and criminal penalties, and will be prosecuted to the 
// maximum extent possible under the law.
//
// $Id: dmz0.so,v 1.00 2003/07/28 1:07 AM nawawi Exp $
//
	include_once('scripts/functions.inc');
	include_once('scripts/auth.inc');
	$_ACCESS=chk_session();
	if($_ACCESS=='' || is_admin($_ACCESS)) {
		write_userlog('Accessing DMZ -> Services setup page','Access denied');
		go_exit();
	}
	if(is_admin($_ACCESS)) {
		write_userlog('Accessing DMZ -> Services setup page','Access denied -> Not Admin');
		echo "you're on candid camera..";
		exit;
	}
	if(isset($do)&& $do=='1') {
		$list=trim(rtrim(($list),','));
		write_dmzlist($list);
		unset($do,$list);
		shell_exec("php ./scripts/dmz.so");
		write_userlog('Executing DMZ -> reloading','Action granted');
		header("Location: dmz_msg.so?msg=Please wait.. saving data and activate..&ref=dmz0.so");
	}
	write_userlog('Accessing DMZ -> Services setup page','Access granted');
	write_nocache();
?>
<?include_once('scripts/header.inc');?>
<html>
<head>
<title>MyBox Firewall</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<?include_once('scripts/style.css');?>
<?include_once('scripts/network.js');?>
<?include_once('scripts/global.js');?>
<script language="javascript1.2"><!--
	defaultStatus="DMZ Services Setup";
	var valupdate='';
	function doselect() {
		var lst=document.f.lst.value;
		valupdate=lst;
		var parray=lst.split("|");
		var extip=parray[0];
		var dmz=parray[1];
		var proto=parray[2];
		var port=parray[3];
		var detail=parray[4];
		var extiplenght=document.f.extip.length;
		var lextip=document.f.extip;

		if(extip=='') return;
		for(var i='0';i<extiplenght;i++) {
			if(lextip[i]!=null) {
				var p=lextip.options[i].text;
				if(p==extip) {
					lextip.options[i].selected=true;
				}
			}
		}
		var hostlenght=document.f.host.length;
		var host=document.f.host;
		for(var i='0';i<hostlenght;i++) {
			if(host[i]!=null) {
				var p=host.options[i].value;
				if(p==dmz) {
					host.options[i].selected=true;
				}
			}
		}

		if(proto=="tcp") {
			document.f.tcp.checked=true;
			document.f.udp.checked=false;
		}
		if(proto=="udp") {
			document.f.tcp.checked=true;
			document.f.udp.checked=false;
		}
		document.f.port.value=port;
		document.f.descr.value=detail;
		return true;
	}
	function dodelete() {
		var lstlenght=document.f.lst.length;
		var list=document.f.lst;
		for(var i='0';i<lstlenght;i++) {
			if(list[i]!=null) {
				if(list.options[i].selected==true) {
					list[i]=null;
				}
			}
		}
		return true;
	}
	function doadd() {
		var extip=document.f.extip.value;
		var host=document.f.host.value;
		var proto="tcp";
		if(document.f.tcp.checked==true) proto="tcp";
		if(document.f.udp.checked==true) proto="udp";
		var port=document.f.port.value;
		var descr=document.f.descr.value;
		descr=descr.replace(/\,/,'');
		if(extip=='NULL' | host=='NULL' | port=='' | !isInteger(port) | descr=='') {
			alert('Invalid input');
			return false;
		}
		var lstlenght=document.f.lst.length;
		var list=document.f.lst;
		var portval=extip+'->'+host+'->'+proto+'->'+port;
		var val=extip+'|'+host+'|'+proto+'|'+port+'|'+descr;
		for(i='0';i<lstlenght;i++) {
			if(list.options[i].value==val) {
				alert('DMZ Service already exists');
				return false;
			}
		}
		document.f.lst[lstlenght]=new Option(portval,val);
		return true;
	}
	function doupdate() {
		var extip=document.f.extip.value;
		var host=document.f.host.value;
		var proto="tcp";
		if(document.f.tcp.checked==true) proto="tcp";
		if(document.f.udp.checked==true) proto="udp";
		var port=document.f.port.value;
		var descr=document.f.descr.value;
		descr=descr.replace(/\,/,'');
		if(extip=='NULL' | host=='NULL' | port=='' | !isInteger(port) | descr=='') {
			alert('Invalid input');
			return false;
		}
		var lstlenght=document.f.lst.length;
		var list=document.f.lst;
		var val=extip+'|'+host+'|'+proto+'|'+port+'|'+descr;
		var portval=valupdate;
		var ok='0';
		for(i='0';i<lstlenght;i++) {
			if(list.options[i].value==portval) {
				list.options[i].value=val;
				ok='1';
			}
		}
		if(!ok) {
			alert('no such DMZ service for update'+portval);
			return false;
		}
		valupdate='';
		return true;
	}
	function dosubmit() {
		var lstlenght=document.f.lst.length;
		var list=document.f.lst;
		var X='';
		for(i='0';i<lstlenght;i++) {
			X +=list.options[i].value;
			X +=',';
		}
		document.f.list.value=X;
		return true;
	}
//--></script>
</head>
<body bgcolor="#888888" leftmargin="0" topmargin="0" marginwidth="0" marginheight="0" onload="initjsDOMenu();">
<!-- start console win -->
<center>
<table bgcolor="#eeeeee" height="100%" width="100%" border="0" cellpadding="0" cellspacing="0" class="block0">
<tr valign="top">
<td align="center">	
<table bgcolor="#005a8f" width="100%" border="0" cellpadding="2" cellspacing="0">
<tr valign="center">
<td height="18" align="left" class="td_label" width=10><img src="png.so?path=image&image=online.gif" border=0 alt="<?get_online();?>"></td>
<td height="18" align="left" class="td_label">&nbsp;DMZ Configuration - Services Setup</td>
<td height="18" align="right"><a href="blank.so"><img src="png.so?path=image&image=close.png" border="0"></a></td>
</tr>
</table>
<table bgcolor="#d4d0c8" width="100%" height="18" border="0" cellpadding="0" cellspacing="0">
<tr valign="center">
<td>
<form name=e>
<nobr>
<input type=button value="DMZ Services Setup" class=input_button onclick="load('dmz0.so');"><input type=button value="DMZ External IP Setup" class=input_button onclick="load('dmz1.so');"><input type=button value="DMZ Hostname Setup" class=input_button onclick="load('dmz2.so');"></nobr>
</td>
</tr>
<tr><td></form></td></tr>
</table>


<table bgcolor="#eeeeee" width="100%" height="100%" border="0" cellpadding="1" cellspacing="1" class="block">
<tr valign="top">
<td align=center><br><br>

<form name=f action=dmz0.so?do=1 method=post>
<table border="0" cellspacing="0" align="center">
<tr>
<td nowrap="nowrap" align=center valign="top">
<fieldset>
<legend>DMZ Listed</legend>
<table border="0" cellspacing="1" cellpadding="0" bgcolor="#E7E9F2">
<tr>
<td valign="top">
<select name=lst class=input_text size=7 multiple onchange="doselect();">
<?
	$dmzhost=array('host'=>'');
	if(file_exists('/hd/configs/dmz_h.lst')) {
		$file=fopen('/hd/configs/dmz_h.lst','r');
		while(!feof($file)) {
			$buff=fgets($file,500);
			$buff=trim($buff);
			if($buff!='') {
				list($ip,$host)=preg_split("/\|/",$buff);
				$dmzhost["$ip"]="$host";
			}
		}
		fclose($file);
	}
	if(file_exists('/hd/configs/dmz.lst')) {
		$file=fopen('/hd/configs/dmz.lst','r');
		while(!feof($file)) {
			$buff=fgets($file,500);
			$buff=trim($buff);
			if($buff!='') {
				list($extip,$hostip,$proto,$port,$desc)=explode('|',$buff);
				//echo "<option value=\"$buff\">$extip"."->$hostip"."->$proto"."->$port"."->$desc</option>\n";
				echo "<option value=\"$buff\">$extip"."->".$dmzhost[$hostip]."->$port"."->$proto</option>\n";
			}
		}
		fclose($file);
	}
?>
</select>

</td>
</tr>
</table>
</fieldset>
</td>
<td valign=top align=center>
<fieldset>
<legend>Services Setup</legend>
<table border="0" cellspacing="1" cellpadding="0" bgcolor="#E7E9F2">
<tr>
<td bgcolor="#E7E9F2">
External IP&nbsp;&nbsp;&nbsp;&nbsp;
</td>
<td bgcolor="#E7E9F2">
<select name="extip" class=input_text>
<option value="NULL" selected>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</option>
<?
	if(file_exists('/hd/configs/dmz_e.lst')) {
		$file=fopen('/hd/configs/dmz_e.lst','r');
		while(!feof($file)) {
			$buff=fgets($file,500);
			$buff=trim($buff);
			list($value,$text,$temp)=explode('|',$buff);
			if($buff!='') {
				echo "<option value=\"$value\">$value</option>\n";
			}
		}
		fclose($file);
	}
?>
</select>
</td>
</tr>
<tr>
<td bgcolor="#E7E9F2">
Map to host&nbsp;&nbsp;&nbsp;&nbsp;
</td>
<td bgcolor="#E7E9F2">
<select name="host" size="1" class=input_text>
<option value="NULL" selected>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</option>
<?
	if(file_exists('/hd/configs/dmz_h.lst')) {
		$file=fopen('/hd/configs/dmz_h.lst','r');
		while(!feof($file)) {
			$buff=fgets($file,500);
			$buff=trim($buff);
			list($value,$text)=preg_split('/\|/',$buff);
			if($buff!='') {
				echo "<option value=\"$value\">$text</option>\n";
			}
		}
		fclose($file);
	}
?>
</select>
</td>
</tr>

<tr>
<td bgcolor="#E7E9F2">
Protocol&nbsp;&nbsp;&nbsp;&nbsp;
</td>
<td bgcolor="#E7E9F2">
<input type=checkbox name=tcp onclick="if(document.f.tcp.checked==true)document.f.udp.checked=false;document.f.tcp.checked=true" checked> TCP <input type=checkbox name=udp onclick="if(document.f.udp.checked==true)document.f.tcp.checked=false;document.f.udp.checked=true"> UDP
</td>
</tr>
<tr>
<td bgcolor="#E7E9F2">
Port&nbsp;&nbsp;&nbsp;&nbsp;
</td>
<td bgcolor="#E7E9F2">
<input type="text" name="port" size="15" value="" class="input_text">
</td>
</tr>
<tr>
<td bgcolor="#E7E9F2">
Description&nbsp;&nbsp;&nbsp;&nbsp;
</td>
<td bgcolor="#E7E9F2">
<input type="text" name="descr" size="15" value="" class="input_text">
</td>
</tr>

</table>
</fieldset>
</td>
</tr>
<tr>
<td colspan="6" align="center">
<input type=button value="Delete Selected" class=input_button onclick="dodelete();"><input type=button value="Add to list" class=input_button onclick="return doadd();"><input type=button value="Update" class=input_button onclick="return doupdate();">&nbsp;<input type="button" value="Cancel" class="input_button" onclick="load('dmz.so');"><input type="submit" value="Save And Active" class="input_button" onclick="return dosubmit();">
</td>
</tr>

</table>
<input type=hidden name=list>
</form>


</td>
</tr>
</table>

</td>
</tr>
</table>

</center>
<!-- end console win -->
</body>
</html>

<? flush(); ?>
