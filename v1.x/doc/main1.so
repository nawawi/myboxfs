#!/bin/php
<?
//
// Mybox Firewall - A Firewall Appliance
// http://www.mybox.net.my/
//
// (C) Copyright 2002,2003,2004 Mohd Nawawi Mohamad Jamili, TraceNetwork Corporation Sdn. Bhd.
//
// This program is not free software; you cannot redistribute it and/or
// modify without permission copyright owner.
//
// This code is protected by copyright law and international treaties. 
// Unauthorized reproduction or distribution of this program, or any portion of it, 
// may result in severe civil and criminal penalties, and will be prosecuted to the 
// maximum extent possible under the law.
//
// $Id: main1.so,v 1.00 2003/07/28 1:07 AM nawawi Exp $
//
	include_once('scripts/functions.inc');
	include_once('scripts/auth.inc');
	include_once('scripts/system.inc');
	$_ACCESS=chk_session();
	if($_ACCESS=='') {
		write_userlog('Accessing System Info','Access denied');
		go_exit();
	}
	write_userlog('Accessing Main -> System Info page','Access granted');
	write_nocache();
?>
<?include_once('scripts/header.inc');?>
<html>
<head>
<title>MyBox Firewall</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<?include_once('scripts/style.css');?>
<?include_once('scripts/global.js');?>
<script language="javascript"><!--
	defaultStatus="System Info";
	function gload() {
		window.status='Info checking...';
		location.href='/main1.so';
	}
	window.setTimeout(gload, '108500');
//--></script>
</head>
<body bgcolor="#888888" leftmargin="0" topmargin="0" marginwidth="0" marginheight="0" scroll=auto onload="initjsDOMenu();">
<!-- start console win -->
<center>
<table bgcolor="#eeeeee" style="width: 100%; height: 100%;" height="100%" width="100%" border="0" cellpadding="0" cellspacing="0" class="block0">
<tr valign="top">
<td align="center">	
<table bgcolor="#005a8f" width="100%" border="0" cellpadding="2" cellspacing="0">
<tr valign="center">
<td height="18" align="left" class="td_label" width=10><img src="png.so?path=image&image=online.gif" border=0 alt="<?get_online();?>"></td>
<td height="18" align="left" class="td_label">&nbsp;Home - System Info</td>
<td height="18" align="right"><a href="blank.so"><img src="png.so?path=image&image=close.png" border="0"></a></td>
</tr>
</table>
<table bgcolor="#d4d0c8" width="100%" height="18" border="0" cellpadding="0" cellspacing="0">
<tr valign="center">
<td>
<form>
<nobr>
<?if(!is_admin($_ACCESS)) {?><input type=button value="System Actions" class=input_button onclick="load('main0.so');"><?}?><input type=button value="System Info" class=input_button onclick="load('main1.so');"><?if(!is_admin($_ACCESS)) {?><input type=button value="System Update" class=input_button onclick="load('main2.so');"><?}?><input type=button value="About MyBox" class=input_button onclick="load('about.so');">
</nobr>
</td>
</tr>
<tr><td></form></td></tr>
</table>
<table bgcolor="#eeeeee" width="100%" height="100%" border="0" cellpadding="1" cellspacing="1" class="block">
<tr valign="top">
<td align=center><br><br>
<table width="600" align="center">
 <tr>
  <td valign="top">
<fieldset>
<legend>System Info</legend>
<table width="100%" align="center">
 <tr>
  <td width="50%" valign="top">
   <table width="100%">
 <tr>
  <td>

    <table class="box">

     <tr class="boxheader">
      <td class="boxheader">System Vital</td>
     </tr>

     <tr>
      <td>
	<table border="0" width="400" align="center">
	<tr><td valign="top" class=td_tab>Canonical Hostname</td><td class=td_tab><?echo chostname();?></td></tr>
	<?
		$ip1=get_ip(get_ini('NETWORK','OUTSIDE_DEV'));
		$ip2=get_ip(get_ini('NETWORK','INSIDE_DEV'));
		$ip3=get_ip(get_ini('NETWORK','DMZ1_DEV'));
		$ip4=get_ip(get_ini('NETWORK','DMZ2_DEV'));
		if($ip1!='N.A') {
	?>
	<tr><td valign="top" class=td_tab>IP External</td><td class=td_tab><?echo $ip1;?></td></tr>
	<? 
		}
		if($ip2!='N.A') {
	?>
	<tr><td valign="top" class=td_tab>IP Secure</td><td class=td_tab><?echo $ip2;?></td></tr>
	<?	
		}
		if($ip3!='N.A') {
	?>
	<tr><td valign="top" class=td_tab>IP Primary DMZ</td><td class=td_tab><?echo $ip3;?></td></tr>
	<?
		}
		if($ip4!='N.A') {
	?>
	<tr><td valign="top" class=td_tab>IP Secondary DMZ</td><td class=td_tab><?echo $ip4;?></td></tr>
	<?	}
		list($num,$name)=preg_split("/-/",kernel());
		list($day,$mon,$dday,$time,$gm,$year)=preg_split("/\s+/",kernel_info());
		$cadmin=kernel_admin();
	?>
	<tr><td valign="top" class=td_tab>Kernel Version</td><td class=td_tab><?echo $name;?></td></tr>
	<tr><td valign="top" class=td_tab>Compiled Time</td><td class=td_tab><?echo "$dday $mon $year $time";?></td></tr>
	<tr><td valign="top" class=td_tab>Compiled by</td><td class=td_tab><?echo "$cadmin";?></td></tr>
	<tr><td valign="top" class=td_tab>Uptime</td><td class=td_tab><?echo uptime();?></td></tr>
	<tr><td valign="top" class=td_tab>Load Averages</td><td class=td_tab><?echo loadavg();?></td></tr></table></td>
     </tr>

    </table>

   </td>
  </tr>
</table>

   <br>
   <table width="100%">
 <tr>
  <td>

    <table class="box">

     <tr class="boxheader">
      <td class="boxheader">Network Usage</td>
     </tr>

     <tr>
      <td><table width="400" align="center"><tr><td align="left" valign="top" class=td_tab><b>Device</b></td><td align="right" valign="top" class=td_tab><b>Received</b></td><td align="right" valign="top" class=td_tab><b>Sent</b></td><td align="right" valign="top" class=td_tab><b>Error</b></td><td align="right" valign="top" class=td_tab><b>Drop</b></td>

	<?
		$net=network();
		while(list($dev, $stats) = each($net)) {
			$dev=trim($dev);
			$rx=trim($stats['rx_bytes']);
			$rx=$rx / 1024;
			$rx=format_bytesize($rx);
			$tx=trim($stats['tx_bytes']);
			$tx=$tx / 1024;
			$tx=format_bytesize($tx);
			$err=trim($stats['errs']);
			$drop=trim($stats['drop']);
			$eth0=get_ini('NETWORK','OUTSIDE_DEV');
			$eth1=get_ini('NETWORK','INSIDE_DEV');
			$eth2=get_ini('NETWORK','DMZ1_DEV');
			$eth3=get_ini('NETWORK','DMZ2_DEV');
			$dev=str_replace('lo','loopback',$dev);
			$dev=str_replace("$eth0",'External',$dev);
			$dev=str_replace("$eth1",'Secure',$dev);
			$dev=str_replace("$eth2",'Primary DMZ',$dev);
			$dev=str_replace("$eth3",'Secondary DMZ',$dev);
			$dev=str_replace('rshaper','Shaper',$dev);
		echo <<<_END_
			<tr>
			<td align="left" valign="top" class=td_tab>$dev</td>
			<td align="right" valign="top" class=td_tab>$rx</td>
			<td align="right" valign="top" class=td_tab>$tx</td>
			<td align="right" valign="top" class=td_tab>$err</td>
			<td align="right" valign="top" class=td_tab>$drop</td>
			</tr>
_END_;
		}
	
	?>

</table></td>
     </tr>

    </table>
<br>
	<?
		$ffilter1='0';
		$ffilter2='0';
		$ffilterl1='0';
		$ffilterl2='0';
		$ffilterl='0';
		$ffilter='0';
		$ffcustl='0';
		$ffcust='0';
		$ffnatl='0';
		$ffnat='0';
		$ffstrl='0';
		$ffstr='0';
		$ffdmzl='0';
		$ffdmz='0';
		$fffwd='0';
		$fffwdl='0';
		function _get_line($what) {
			$cnt='0';
			$line=file($what);
			foreach($line as $l) {
				$l=trim($l);
				if($l!='') {
					$cnt++;
				}
			}
			return $cnt;
		}
		function _get_size($what) {
			$what=$what / 1024;
			$what=format_bytesize($what);
			return "$what";
		}
		if(file_exists('/hd/configs/fwcusoa.lst')) {
			$ffilter1=filesize('/hd/configs/fwcusoa.lst');
			$ffilterl1=_get_line('/hd/configs/fwcusoa.lst');
		}
		if(file_exists('/hd/configs/fwcusta.lst')) {
			$ffilter2=filesize('/hd/configs/fwcusta.lst');
			$ffilterl2=_get_line('/hd/configs/fwcusta.lst');
		}
		if(file_exists('/hd/configs/fwrule.lst')) {
			$ffcust=filesize('/hd/configs/fwrule.lst');
			$ffcustl=_get_line('/hd/configs/fwrule.lst');
		}
		if(file_exists('/hd/configs/fwdrule.lst')) {
			$fffwd=filesize('/hd/configs/fwdrule.lst');
			$fffwdl=_get_line('/hd/configs/fwdrule.lst');
		}
		if(file_exists('/hd/configs/natrule.lst')) {
			$ffnat=filesize('/hd/configs/natrule.lst');
			$ffnatl=_get_line('/hd/configs/natrule.lst');
		}
		if(file_exists('/hd/configs/strrule.lst')) {
			$ffstr=filesize('/hd/configs/strrule.lst');
			$ffstrl=_get_line('/hd/configs/strrule.lst');
		}
		if(file_exists('/hd/configs/dmz.lst')) {
			$ffdmz=filesize('/hd/configs/dmz.lst');
			$ffdmzl=_get_line('/hd/configs/dmz.lst');
		}
		$ffilter=$ffilter1 + $ffilter2;
		$ffilter=_get_size($ffilter);
		$ffilterl=$ffilterl1 + $ffilterl2;
		$ffcust=_get_size($ffcust);
		$fffwd=_get_size($fffwd);
		$ffnat=_get_size($ffnat);
		$ffstr=_get_size($ffstr);
		$ffdmz=_get_size($ffdmz);
		clearstatcache();
		
	if(!is_admin($_ACCESS)) {
	?>

   <table class="box">
     <tr class="boxheader">
      <td class="boxheader">Config File Information</td>
     </tr>
     <tr>
      <td>
	<table width="400" align="center">
	<tr>
	<td align="left" valign="top" class=td_tab><b>Config File</b></td>
	<td align="right" valign="top" class=td_tab><b>Line</b></td>
	<td align="right" valign="top" class=td_tab><b>Size</b></td>
	</tr>
	<tr>
	<td align="left" valign="top" class=td_tab>Filter Policy</td>
	<td align="right" valign="top" class=td_tab><?echo $ffilterl;?></td>
	<td align="right" valign="top" class=td_tab><?echo $ffilter;?></td>
	</tr>
	<tr>
	<td align="left" valign="top" class=td_tab>Custom Policy</td>
	<td align="right" valign="top" class=td_tab><?echo $ffcustl;?></td>
	<td align="right" valign="top" class=td_tab><?echo $ffcust;?></td>
	</tr>
	<tr>
	<td align="left" valign="top" class=td_tab>Interfaces Policy</td>
	<td align="right" valign="top" class=td_tab><?echo $fffwdl;?></td>
	<td align="right" valign="top" class=td_tab><?echo $fffwd;?></td>
	</tr>
	<tr>
	<td align="left" valign="top" class=td_tab>Nat Policy</td>
	<td align="right" valign="top" class=td_tab><?echo $ffnatl;?></td>
	<td align="right" valign="top" class=td_tab><?echo $ffnat;?></td>
	</tr>
	<tr>
	<td align="left" valign="top" class=td_tab>String Policy</td>
	<td align="right" valign="top" class=td_tab><?echo $ffstrl;?></td>
	<td align="right" valign="top" class=td_tab><?echo $ffstr;?></td>
	</tr>
	<tr>
	<td align="left" valign="top" class=td_tab>DMZ Policy</td>
	<td align="right" valign="top" class=td_tab><?echo $ffdmzl;?></td>
	<td align="right" valign="top" class=td_tab><?echo $ffdmz;?></td>
	</tr>
</table></td>
     </tr>

    </table> <? } ?>


   </td>
  </tr>
</table>


  </td>

  <td width="50%" valign="top" class=td_tab>
   <table width="200">
 <tr>
  <td>


    <table class="box">

     <tr class="boxheader">
      <td class="boxheader">Memory Information</td>
     </tr>
	<?
		$memtotal='0';
		$memfree='0';
		$memshared='0';
		$membuff='0';
		$memcached='0';
		$memswapcached='0';
		$memactive='0';
		$meminactive='0';
		$memhightotal='0';
		$memhighfree='0';
		$memlowtotal='0';
		$memlowfree='0';
		$memswaptotal='0';
		$memswapfree='0';
		if(file_exists('/proc/meminfo')) {
			$handle=fopen('/proc/meminfo','r');
			while($buff=fgets($handle,151)) {
				$buff=trim($buff);
				if($buff!='') {
					if(preg_match("/^MemTotal:\s+(\d+)\s*kB$/",$buff,$mem)) {
						$memtotal1=$mem[1];
						$memtotal=format_bytesize($mem[1]);
					}
					if(preg_match("/^MemFree:\s+(\d+)\s*kB$/",$buff,$mem)) {
						$memfree1=$mem[1];
						$memfree=format_bytesize($mem[1]);
					}/*
					if(preg_match("/^MemShared:\s+(\d+)\s*kB$/",$buff,$mem)) {
						$memshared=format_bytesize($mem[1]);
					}*/
					if(preg_match("/^Buffers:\s+(\d+)\s*kB$/",$buff,$mem)) {
						$membuff=format_bytesize($mem[1]);
					}
					if(preg_match("/^Cached:\s+(\d+)\s*kB$/",$buff,$mem)) {
						$memcached=format_bytesize($mem[1]);
					}
					if(preg_match("/^SwapCached:\s+(\d+)\s*kB$/",$buff,$mem)) {
						$memswapcached=format_bytesize($mem[1]);
					}
					if(preg_match("/^Active:\s+(\d+)\s*kB$/",$buff,$mem)) {
						$memactive=format_bytesize($mem[1]);
					}
					if(preg_match("/^Inactive:\s+(\d+)\s*kB$/",$buff,$mem)) {
						$meminactive=format_bytesize($mem[1]);
					}/*
					if(preg_match("/^HighTotal:\s+(\d+)\s*kB$/",$buff,$mem)) {
						$memhightotal=format_bytesize($mem[1]);
					}
					if(preg_match("/^HighFree:\s+(\d+)\s*kB$/",$buff,$mem)) {
						$memhighfree=format_bytesize($mem[1]);
					}*/
					if(preg_match("/^LowTotal:\s+(\d+)\s*kB$/",$buff,$mem)) {
						$memlowtotal=format_bytesize($mem[1]);
					}
					if(preg_match("/^LowFree:\s+(\d+)\s*kB$/",$buff,$mem)) {
						$memlowfree=format_bytesize($mem[1]);
					}
					if(preg_match("/^SwapTotal:\s+(\d+)\s*kB$/",$buff,$mem)) {
						$memswaptotal=format_bytesize($mem[1]);
					}/*
					if(preg_match("/^SwapFree:\s+(\d+)\s*kB$/",$buff,$mem)) {
						$memswapfree=format_bytesize($mem[1]);
					}*/
				}
			}
			fclose($handle);
		}
		$memusage=$memtotal1 - $memfree1;
		$memusage=format_bytesize($memusage);
	?>
     <tr>
      <td>
	<table border="0" width="90%" align="center">
	<tr>
	<td valign="top" class=td_tab>MemUsage</td>
	<td><?echo $memusage;?></td>
	</tr>
	<tr>
	<td valign="top" class=td_tab>MemTotal</td>
	<td><?echo $memtotal;?></td>
	</tr>
	<tr>
	<td valign="top" class=td_tab>MemFree</td>
	<td><?echo $memfree;?></td>
	</tr>
	<?/*<tr>
	<td valign="top" class=td_tab>MemShared</td>
	<td><?echo $memshared;?></td>
	</tr>*/?>
	<tr>
	<td valign="top" class=td_tab>Buffers</td>
	<td><?echo $membuff;?></td>
	</tr>
	<tr>
	<td valign="top" class=td_tab>Cached</td>
	<td><?echo $memcached;?></td>
	</tr>
	<tr><td valign="top" class=td_tab>Active</td>
	<td><?echo $memactive;?></td>
	</tr>
	<tr>
	<td valign="top" class=td_tab>InActive</td>
	<td><?echo $meminactive;?></td>
	</tr>
	<tr>
	<td valign="top" class=td_tab>HighTotal</td>
	<td><?echo $memhightotal;?></td>
	</tr>
	<?/*<tr>
	<td valign="top" class=td_tab>HighFree</td>
	<td><?echo $memhighfree;?></td>
	</tr>
	<tr>
	<td valign="top" class=td_tab>LowTotal</td>
	<td><?echo $memlowtotal;?></td>
	</tr>
	<tr>
	<td valign="top" class=td_tab>LowFree</td>
	<td><?echo $memlowfree;?></td>
	</tr>*/?>
	<tr>
	<td valign="top" class=td_tab>Swap</td>
	<td><?echo $memswaptotal;?></td>
	</tr>
	<?/*<tr>
	<td valign="top" class=td_tab>SwapFree</td>
	<td><?echo $memswapfree;?></td>
	</tr>*/?>
	</table>
	</td>
     </tr>

    </table>
<br>
   <table class="box">
	<?
		$alert='1';
		$ids_sensor='<font color=red>Stopped</font>';
		$ids_parse='<font color=red>Stopped</font>';
		$kernel_parse='<font color=red>Stopped</font>';
		$miniserv_warp='<font color=red>Stopped</font>';
		$crond='<font color=red>Stopped</font>';
		$failover='<font color=red>Stopped</font>';
		$query='<font color=red>Stopped</font>';
		$sys=popen('ps','r');
		while($buff=fgets($sys)) {
			if(strstr($buff,'ids_sensor')) { 
				$ids_sensor='<font color=green>Running</font>';
				$alert++;
			}
			if(strstr($buff,'ids_parse.so')) { 
				$ids_parse='<font color=green>Running</font>'; 
				$alert++; 
			}
			if(strstr($buff,'kernel_parse.so')) { 
				$kernel_parse='<font color=green>Running</font>'; 
				$alert++;
			}
			if(strstr($buff,'miniserv_wrap')) { 
				$miniserv_warp='<font color=green>Running</font>'; 
				$alert++;
			}
			if(strstr($buff,'crond')) { 
				$crond='<font color=green>Running</font>'; 
				$alert++; 
			}
			if(strstr($buff,'failover.so')) { 
				$failover='<font color=green>Running</font>'; 
				$alert++; 
			}
			if(strstr($buff,'qout.so')) { 
				$query='<font color=green>Running</font>'; 
				$alert++; 
			}
		}
		pclose($sys);
		if(!is_admin($_ACCESS)) {
	?>
     <tr class="boxheader">
      <td class="boxheader">System Services</td>
     </tr>
     <tr>
      <td>
	<table border="0" width="90%" align="center">
	<tr>
	<td valign="top" class=td_tab>IDS Sensor</td>
	<td><?echo $ids_sensor;?></td>
	</tr>
	<tr>
	<td valign="top" class=td_tab>IDS Parser</td>
	<td><?echo $ids_parse;?></td>
	</tr>
	<tr>
	<td valign="top" class=td_tab>Kernel Parser</td>
	<td><?echo $kernel_parse;?></td>
	</tr>
	<tr>
	<td valign="top" class=td_tab>Mini Server</td>
	<td><?echo $miniserv_warp;?></td>
	</tr>
	<tr>
	<td valign="top" class=td_tab>Cron Manager</td>
	<td><?echo $crond;?></td>
	</tr>
	<tr>
	<td valign="top" class=td_tab>Link Failover</td>
	<td><?echo $failover;?></td>
	</tr>
	<tr>
	<td valign="top" class=td_tab>Query Service</td>
	<td><?echo $query;?></td>
	</tr>
	</table>
	</td>
     </tr> <?}?>
    </table>
   </td>
  </tr>
</table>
  </td>
 </tr>
</fieldset>
   </td>
  </tr>
</table>
   </td>
  </tr>
</table>
</td>
</tr>
</table>
</td>
</tr>
</table></center>
<!-- end console win -->
</body>
</html>
<? flush(); ?>