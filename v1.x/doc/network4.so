#!/bin/php
<?
//
// Mybox Firewall - A Firewall Appliance
// http://www.mybox.net.my/
//
// (C) Copyright 2002,2003,2004 Mohd Nawawi Mohamad Jamili, TraceNetwork Corporation Sdn. Bhd.
//
// This program is not free software; you cannot redistribute it and/or
// modify without permission copyright owner.
//
// This code is protected by copyright law and international treaties. 
// Unauthorized reproduction or distribution of this program, or any portion of it, 
// may result in severe civil and criminal penalties, and will be prosecuted to the 
// maximum extent possible under the law.
//
// $Id: network4.so,v 1.00 2003/07/28 1:07 AM nawawi Exp $
//
	include_once('scripts/functions.inc');
	include_once('scripts/auth.inc');
	$_ACCESS=chk_session();
	if($_ACCESS=='' || is_admin($_ACCESS)) {
		write_userlog('Accessing Network -> Bandwidth page','Access denied');
		go_exit();
	}
	if(is_admin($_ACCESS)) {
		write_userlog('Accessing Network -> Bandwidth page','Access denied -> Not Admin');
		echo "you're on candid camera..";
		exit;
	}
	if(isset($ch2)&& $ch2=='1') {
		if($row=='up') {
			upline('shaper',$line);
		} else {
			downline('shaper',$line);
		}
		unset($ch2,$row,$line);
	}
	if(isset($ch1)&& $ch1=='1') {
		if($active==1) {
			$active='0';
		} else {
			$active='1';
		}
		change_stat('shaper','active',$line,$active);
		unset($ch1,$active);
	}
	if(isset($do)&& $do=='1') {
		if(isset($action)&& $action=='delete') {
			do_delete('shaper',$del);
		}
		if(isset($action)&& $action=='active') {
			shell_exec("php ./scripts/shaper.so");
			write_userlog('Executing Network -> Bandwidth -> Reload','Action granted');
			header("Location: network_msg.so?ref=network4.so&msg=Please wait.. reloading..");
		}
		unset($do,$action);
	}

	function size_convert($size) {
		if($size >= 1073741824) {
			$size=$size / 1073741824;
			if($size==1024) $size='1';
			return "$size Gb";
		}
		if($size >= 1048576) {
			$size=$size / 1048576;
			if($size==1024) $size='1';
			return "$size Mb";
		}
		if($size >= 1024) {
			$size=$size / 1024;
			return "$size Kb";
		}
		$size=$size / 1024;
		return "$size Kb";
	}

	write_userlog('Accessing Network -> Bandwidth page','Access granted');
	write_nocache();
?>
<?include_once('scripts/header.inc');?>
<html>
<head>
<title>MyBox Firewall</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<?include_once('scripts/style.css');?>
<?include_once('scripts/global.js');?>
<script language="javascript1.2"><!--
	defaultStatus="Bandwidth Shaping";
	function dotoggle() {
		  for(var i = 0; i < document.f.elements.length; i++) {
			if(document.f.elements[i].type=='checkbox') {
			    	if( document.f.elements[i].name.substr( 0, 3 ) == 'del') {
					document.f.elements[i].checked = !(document.f.elements[i].checked);
    				}	
			}
  		}
	}
	function dodelete() {
		document.f.action.value='delete';
		document.f.submit();
	}
	function doactive() {
		document.f.action.value='active';
		document.f.submit();
	}
//--></script>
</head>
<body bgcolor="#888888" leftmargin="0" topmargin="0" marginwidth="0" marginheight="0" onload="initjsDOMenu();">
<!-- start console win -->
<center>
<table bgcolor="#eeeeee" height="100%" width="100%" border="0" cellpadding="0" cellspacing="0" class="block0">
<tr valign="top">
<td align="center">	
<table bgcolor="#005a8f" width="100%" border="0" cellpadding="2" cellspacing="0">
<tr valign="center">
<td height="18" align="left" class="td_label" width=10><img src="png.so?path=image&image=online.gif" border=0 alt="<?get_online();?>"></td>
<td height="18" align="left" class="td_label">&nbsp;Network Configuration - Bandwidth Shaping</td>
<td height="18" align="right"><a href="blank.so"><img src="png.so?path=image&image=close.png" border="0"></a></td>
</tr>
</table>
<table bgcolor="#d4d0c8" width="100%" height="18" border="0" cellpadding="0" cellspacing="0">
<tr valign="center">
<td>
<form name=e>
<nobr>
<input type=button value="DNS/Gateway" class=input_button onclick="load('network0.so');"><input type=button value="Interfaces Setup" class=input_button onclick="load('network1.so');"><input type=button value="Routing Setup" class=input_button onclick="load('network5.so');"><input type=button value="Host Addresses" class=input_button onclick="load('network2.so');"><input type=button value="ARP Cache" class=input_button onclick="load('network3.so');"><input type=button value="Bandwidth Shaping" class=input_button onclick="load('network4.so');"><input type=button value="Link Failover" class=input_button onclick="load('network6.so');">
</nobr>
</td>
</tr>
<tr><td></form></td></tr>
</table>


<table bgcolor="#eeeeee" width="100%" height="100%" border="0" cellpadding="1" cellspacing="1" class="block">
<tr valign="top">
<td align=center><br><br>
<form name=f action=network4.so?do=1 method=post>
    <table cellpadding="5" border="0" cellspacing="0" align="center">
    <tr>
        <td valign="top" width="700" align=center>
            <fieldset>
                <legend>Bandwidth Shaping</legend><br>
                <table border="0" cellspacing="1" cellpadding="0">
	<tr>
	<td align=right><input type=button value="New Source" class=input_button onclick="load('network4.1.so');">&nbsp;&nbsp;&nbsp;<input type=button value="Reload" class=input_button onclick="doactive();"><input type=button value="Delete Selected" class=input_button onclick="dodelete();"><input type=button value="Toggle" class=input_button onclick="dotoggle();"></td>
	</tr>
	<tr><td></td></tr>
                    <tr>
                        <td>
                               <table width="650" border="0" cellpadding="1" cellspacing="1" class=block>

      <tr bgcolor="#6696bc">
        <td class=td_pad>Id</td> 
        <td class=td_pad>Source</td>
        <td class=td_pad>Trans</td>
	<td class=td_pad>Size</td>
        <td class=td_pad>Description</td>
        <td class=td_pad>Active</td>
        <td class=td_pad>Opt</td>
        <td class=td_pad>Shift</td>
      </tr>
	<?
		if(file_exists('/hd/configs/bandwidth.lst')) {
			$file=fopen('/hd/configs/bandwidth.lst','r');
			$cnt='0';
			while(!feof($file)) {
				$buff=fgets($file,4096);
				$buff=trim($buff);
				if($buff!='') {
					list($src,$trans,$que,$desc,$active)=preg_split("/\|/",$buff);
					$image[0]='image/no.png';
					$image[1]='image/yes.png';
					if($trans!='') {
						$trans=size_convert($trans);
						list($size,$name)=preg_split("/\s+/",$trans);
					}
					echo "
      					<tr bgcolor=\"#E7E9F2\"> 
        				<td class=td_pad>$cnt</td>
        				<td class=td_pad>$src</td>
					<td class=td_pad>$size</td>
					<td class=td_pad>$name</td>
        				<td class=td_pad>$desc</td>
        				<td align=center class=td_pad><a href=\"network4.so?ch1=1&active=$active&line=$cnt\"><img src=\"$image[$active]\" border=0></a></td>
        				<td class=td_pad><input type=checkbox name=del[$cnt] value=$cnt></td>
        				<td class=td_pad><a href=\"network4.so?ch2=1&row=up&line=$cnt\"><img src=\"image/arrow_up.png\" border=0></a><a href=\"network4.so?ch2=1&row=down&line=$cnt\"><img src=\"image/arrow_down.png\" border=0></a></td>
      					</tr>

					";
				}
			$cnt++;
			}
			fclose($file);
		}
	?>
</table>
<tr><td></td></tr>
	<tr>
	<td align=right><input type=button value="New Source" class=input_button onclick="load('network4.1.so');">&nbsp;&nbsp;&nbsp;<input type=button value="Reload" class=input_button onclick="doactive();"><input type=button value="Delete Selected" class=input_button onclick="dodelete();"><input type=button value="Toggle" class=input_button onclick="dotoggle();"><br><br></td>
	</tr>
                     </tr>
                        </td>
                    </tr>

            </fieldset>
         </td>
    </tr>
    </table>
<input type=hidden name=action>
</form>

</td>
</tr>
</table>
</td>
</tr>
</table>
</center>
<!-- end console win -->
</body>
</html>

<? flush(); ?>
