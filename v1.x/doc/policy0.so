#!/bin/php
<?
//
// Mybox Firewall - A Firewall Appliance
// http://www.mybox.net.my/
//
// (C) Copyright 2002,2003,2004 Mohd Nawawi Mohamad Jamili, TraceNetwork Corporation Sdn. Bhd.
//
// This program is not free software; you cannot redistribute it and/or
// modify without permission copyright owner.
//
// This code is protected by copyright law and international treaties. 
// Unauthorized reproduction or distribution of this program, or any portion of it, 
// may result in severe civil and criminal penalties, and will be prosecuted to the 
// maximum extent possible under the law.
//
// $Id: policy0.so,v 1.00 2003/07/28 1:07 AM nawawi Exp $
//
	include_once('scripts/functions.inc');
	include_once('scripts/auth.inc');
	$_ACCESS=chk_session();
	if($_ACCESS=='' || is_admin($_ACCESS)) {
		write_userlog('Accessing Policy -> Filter page','Access denied');
		go_exit();
	}
	if(is_admin($_ACCESS)) {
		write_userlog('Accessing Policy -> Filter page','Access denied -> Not Admin');
		echo "you're on candid camera..";
		exit;
	}
	if( (isset($do)&& $do=='1') && (isset($action)&& $action=='write') ) {
		$list0=trim(rtrim(($dropinlist),','));
		$list1=trim(rtrim(($acceptinlist),','));
		$list2=trim(rtrim(($dropoutlist),','));
		$list3=trim(rtrim(($acceptoutlist),','));
		write_customlist($list0,$list1,$list2,$list3);
		$MSG="Setting Updated.";
		unset($do,$action,$list0,$list1,$list2,$list3);
		write_userlog('Exceuting Policy -> Filter -> Saving data','Action granted');
		header("Location: policy_msg.so?ref=policy0.so&msg=Please wait.. saving data..");
	}

	if( (isset($do)&& $do=='1') && (isset($action)&& $action=='active') ) {
		shell_exec("php ./scripts/filter_rule.so");
		unset($do,$action);
		write_userlog('Exceuting Policy -> Filter -> reloading','Action granted');
		header("Location: policy_msg.so?ref=policy0.so&msg=Please wait.. reloading.");
	}

	write_userlog('Accessing Policy page','Access granted');
	write_nocache();
?>
<?include_once('scripts/header.inc');?>
<html>
<head>
<title>MyBox Firewall</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<?include_once('scripts/style.css');?>
<?include_once('scripts/global.js');?>
<script language="javascript"><!--
	defaultStatus="Filter Policy";
	function inmoveto(a) {
		if(a=="right") {
			var v=document.f.dropin.value;
			var p=document.f.acceptin.length;
			var lstlenght=document.f.dropin.length;
			var list=document.f.dropin;
			for(var i='0';i<lstlenght;i++) {
				if(list[i]!=null) {
					if(list.options[i].value==v) {
						document.f.acceptin[p]=new Option(v,v);
						list[i]=null;
					}
				}
			}
		}

		if(a=="left") {
			var v=document.f.acceptin.value;
			var p=document.f.dropin.length;
			var lstlenght=document.f.acceptin.length;
			var list=document.f.acceptin;
			for(var i='0';i<lstlenght;i++) {
				if(list[i]!=null) {
					if(list.options[i].value==v) {
						document.f.dropin[p]=new Option(v,v);
						list[i]=null;
					}
				}
			}
		}
	}

	function outmoveto(a) {
		if(a=="right") {
			var v=document.f.dropout.value;
			var p=document.f.acceptout.length;
			var lstlenght=document.f.dropout.length;
			var list=document.f.dropout;
			for(var i='0';i<lstlenght;i++) {
				if(list[i]!=null) {
					if(list.options[i].value==v) {
						document.f.acceptout[p]=new Option(v,v);
						list[i]=null;
					}
				}
			}
		}
		if(a=="left") {
			var v=document.f.acceptout.value;
			var p=document.f.dropout.length;
			var lstlenght=document.f.acceptout.length;
			var list=document.f.acceptout;
			for(var i='0';i<lstlenght;i++) {
				if(list[i]!=null) {
					if(list.options[i].value==v) {
						document.f.dropout[p]=new Option(v,v);
						list[i]=null;
					}
				}
			}
		}
	}
	function dosubmit() {
		var lstlenght=document.f.dropin.length;
		var list=document.f.dropin;
		var dropin='';
		for(i='0';i<lstlenght;i++) {
			dropin +=list.options[i].value;
			dropin +=',';
		}
		var lstlenght=document.f.acceptin.length;
		var list=document.f.acceptin;
		var acceptin='';
		for(i='0';i<lstlenght;i++) {
			acceptin +=list.options[i].value;
			acceptin +=',';
		}

		var lstlenght=document.f.dropout.length;
		var list=document.f.dropout;
		var dropout='';
		for(i='0';i<lstlenght;i++) {
			dropout +=list.options[i].value;
			dropout +=',';
		}
		var lstlenght=document.f.acceptout.length;
		var list=document.f.acceptout;
		var acceptout='';
		for(i='0';i<lstlenght;i++) {
			acceptout +=list.options[i].value;
			acceptout +=',';
		}

		document.f.dropinlist.value=dropin;
		document.f.acceptinlist.value=acceptin;

		document.f.dropoutlist.value=dropout;
		document.f.acceptoutlist.value=acceptout;
		document.f.action.value='write';
		document.f.submit();
	}
	function doactive() {
		document.f.action.value='active';
		document.f.submit();
	}
//--></script>
</head>
<body bgcolor="#888888" leftmargin="0" topmargin="0" marginwidth="0" marginheight="0" onload="initjsDOMenu();">
<!-- start console win -->

<center>
<table bgcolor="#eeeeee" height="100%" width="100%" border="0" cellpadding="0" cellspacing="0" class="block0">
<tr valign="top">
<td align="center">	
<table bgcolor="#005a8f" width="100%" border="0" cellpadding="2" cellspacing="0">
<tr valign="center">
<td height="18" align="left" class="td_label" width=10><img src="png.so?path=image&image=online.gif" border=0 alt="<?get_online();?>"></td>
<td height="18" align="left" class="td_label">&nbsp;Policy Configuration - Filter Policy</td>
<td height="18" align="right"><a href="blank.so"><img src="png.so?path=image&image=close.png" border="0"></a></td>
</tr>
</table>
<table bgcolor="#d4d0c8" width="100%" height="18" border="0" cellpadding="0" cellspacing="0">
<tr valign="center">
<td>
<form name=d>
<nobr>
<input type=button value="Filter Policy" class=input_button onclick="load('policy0.so');"><input type=button value="Custom Policy" class=input_button onclick="load('policy1.so');"><input type=button value="Interfaces Policy" class=input_button onclick="load('policy5.so');"><input type=button value="DNAT Policy" class=input_button onclick="load('policy2.so');"><input type=button value="SNAT Policy" class=input_button onclick="load('policy6.so');"><input type=button value="String Policy" class=input_button onclick="load('policy3.so');"><input type=button value="IP Sysctl Setup" class=input_button onclick="load('policy4.so');"></nobr>
</td>
</tr>
<tr><td></form></td></tr>
</table>


<table bgcolor="#eeeeee" width="100%" height="100%" border="0" cellpadding="1" cellspacing="1" class="block">
<tr valign="top">
<td align=center><br><br>

<form name=f action=policy0.so?do=1 method=post>
<table cellpadding="5" border="0" cellspacing="0" align="center">
<tr>
<td valign="top" width="700" align=center>
<fieldset>
<legend>Filter Policy</legend><br>
<!------------------>
<table cellpadding="5" border="0" cellspacing="0" align="center">
<tr>
<td valign="top" width="700" align=center>
<!------------------->
Choose Allowable Incoming Services
<table cellpadding="5" border="0" cellspacing="0" align="center">
<tr>
<td valign="top" width="250" align=center>
<fieldset>
<legend>Drop</legend>
<table border="0" cellspacing="1" cellpadding="0">
<tr>
<td align=center>
<select name=dropin class=input_text size=8 multiple>
<?
	if(file_exists('/hd/configs/fwcustd.lst')) {
		$file=fopen('/hd/configs/fwcustd.lst','r');
		while(!feof($file)) {
			$buff=fgets($file,500);
			$buff=trim($buff);
			if($buff!='') {
				echo "<option value=\"$buff\">$buff</option>\n";
			}
		}
		fclose($file);
	}
?>
</select>
</td>
</tr>
</table>
</fieldset>
</td>

<td valign="middle" width="50">

<table border="0" cellspacing="1" cellpadding="0">
<tr>
<td>
<input type=button value=" >> " class=input_arrow onclick="inmoveto('right');">
</td>
</tr>
<tr>
<td>
<input type=button value=" << " class=input_arrow onclick="inmoveto('left');">
</td>
</tr>
</table>
</td>

<td valign="top" width="250" align=center>
<fieldset>
<legend>Accept</legend>
<table border="0" cellspacing="1" cellpadding="0">
<tr>
<td align=center>
<select name=acceptin class=input_text size=8 multiple>
<?
	if(file_exists('/hd/configs/fwcusta.lst')) {
		$file=fopen('/hd/configs/fwcusta.lst','r');
		while(!feof($file)) {
			$buff=fgets($file,500);
			$buff=trim($buff);
			if($buff!='') {
				echo "<option value=\"$buff\">$buff</option>\n";
			}
		}
		fclose($file);
	}
?>
</select>
</td>
</tr>
</table>
</fieldset>
</td>
</tr>
</table>
<!-------------------->
</td>
</tr>
<tr>
<td valign="top" width="700" align=center>
<!------------------->
Choose Allowable Outgoing Services
<table cellpadding="5" border="0" cellspacing="0" align="center">
<tr>
<td valign="top" width="250" align=center>
<fieldset>
<legend>Drop</legend>
<table border="0" cellspacing="1" cellpadding="0">
<tr>
<td align=center>
<select name=dropout class=input_text size=8 multiple>
<?
	if(file_exists('/hd/configs/fwcusod.lst')) {
		$file=fopen('/hd/configs/fwcusod.lst','r');
		while(!feof($file)) {
			$buff=fgets($file,500);
			$buff=trim($buff);
			if($buff!='') {
				echo "<option value=\"$buff\">$buff</option>\n";
			}
		}
		fclose($file);
	}
?>
</select>
</td>
</tr>
</table>
</fieldset>
</td>


<td valign="middle" width="50">
<table border="0" cellspacing="1" cellpadding="0">
<tr>
<td>
<input type=button value=" >> " class=input_arrow onclick="outmoveto('right');">
</td>
</tr>
<tr>
<td>
<input type=button value=" << " class=input_arrow onclick="outmoveto('left');">
</td>
</tr>
</table>
</td>

<td valign="top" width="250" align=center>
<fieldset>
<legend>Accept</legend>
<table border="0" cellspacing="1" cellpadding="0">
<tr>
<td align=center>
<select name=acceptout class=input_text size=8 multiple>
<?
	if(file_exists('/hd/configs/fwcusoa.lst')) {
		$file=fopen('/hd/configs/fwcusoa.lst','r');
		while(!feof($file)) {
			$buff=fgets($file,500);
			$buff=trim($buff);
			if($buff!='') {
				echo "<option value=\"$buff\">$buff</option>\n";
			}
		}
		fclose($file);
	}
?>
</select>
</td>
</tr>
</table>
</fieldset>
</td>
</tr>
</table>
<!----------------------->
</td>
</tr>
</table>
<!----------------------->
<br><br>
</fieldset>
</td>
</tr>
<tr>
<td colspan="3" align="center">
<input type="button" value="Cancel" class="input_button" onclick="load('policy.so');">&nbsp;&nbsp;<input type="button" value="Reload" class="input_button" onclick="doactive();"><input type="button" value="Save This Setting" class="input_button" onclick="dosubmit();">
</td>
</tr>
</table>
<input type=hidden name=dropinlist>
<input type=hidden name=acceptinlist>
<input type=hidden name=dropoutlist>
<input type=hidden name=acceptoutlist>
<input type=hidden name=action>      
</form>
</td>
</tr>
</table>

</td>
</tr>
</table>
</center>
<!-- end console win -->
</body>
</html>

<? flush(); ?>
